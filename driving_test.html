<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>טופס מבחן נהיגה - צה"ל - משרד הרישוי</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f4f4; padding: 20px; direction: rtl; }
        
        /* מיכל הטופס */
        .form-container { 
            max-width: 1100px; margin: auto; background: white; padding: 30px; 
            border: 2px solid #000; box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        }
        
        .header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
        .header h1 { margin: 0; font-size: 24px; color: #1a3a1a; }
        .header h2 { margin: 2px 0; font-size: 18px; }

        .top-info { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .vehicle-types { font-size: 12px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; border: 1px solid #ccc; padding: 5px; background: #f9f9f9; }
        
        .details-section { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 15px; background: #fdfdfd; padding: 5px; border: 1px solid #eee; }
        .field { display: flex; flex-direction: column; gap: 2px; }
        .field label { font-weight: bold; font-size: 11px; color: #555; }
        input[type="text"], input[type="date"], input[type="time"] { 
            border: 1px solid #ccc; border-radius: 3px; width: 100%; padding: 4px; 
            font-family: inherit; font-size: 13px; font-weight: bold; background: #fff;
        }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; border: 2px solid #000; }
        .column { border: 0.5px solid #000; display: flex; flex-direction: column; }
        .column-title { background: #333; color: #fff; font-weight: bold; text-align: center; padding: 5px; border-bottom: 2px solid #000; font-size: 14px; }
        
        .row-item { display: flex; align-items: center; border-bottom: 1px solid #ccc; padding: 2px 5px; min-height: 28px; page-break-inside: avoid; flex-wrap: wrap; }
        .label-text { flex: 1; font-size: 12px; font-weight: 500; line-height: 1.1; min-width: 120px; }
        
        .score-select { width: 60px; font-size: 11px; margin-left: 5px; border: 1px solid #ccc; cursor: pointer; height: 22px; }
        
        /* סלקט הנימוקים */
        .reason-select {
            display: none; 
            width: 100%; margin-top: 4px; font-size: 12px; font-weight: bold;
            color: #b00; border: 1px solid #ffcccc; background: #fff5f5; padding: 3px;
        }

        .visual-box { width: 22px; height: 22px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; background: #fff; margin-right: 5px; flex-shrink: 0; }
        .v-mark { color: green; }
        .x-mark { color: red; }
        .ox-mark { color: red; width: 16px; height: 16px; border: 2px solid red; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; }

        .footer { margin-top: 10px; display: flex; gap: 15px; }
        
        /* תיבת הערות מתרחבת */
        .notes-area { 
            flex: 2; 
            min-height: 80px; /* גובה התחלתי */
            border: 1px solid #000; 
            padding: 5px; 
            font-family: inherit; 
            resize: none; /* ביטול גרירה ידנית */
            font-size: 13px; 
            line-height: 1.4; 
            background: #fffff0; 
            overflow: hidden; /* הסתרת גלילה */
            height: auto;
        }
        
        .summary-box { flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 5px; }
        .fail-stamp { border: 3px solid red; color: red; padding: 2px 10px; text-align: center; font-size: 20px; font-weight: bold; transform: rotate(-3deg); align-self: center; }

        .digital-sig-box { text-align: center; border: 1px dashed #999; padding: 2px; background: #fff; }
        canvas { cursor: crosshair; display: block; margin: 0 auto; }
        .clear-btn { background: #eee; border: 1px solid #ccc; font-size: 10px; padding: 2px 5px; cursor: pointer; margin-top: 2px; width: 100%; }

        .bottom-actions { text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .btn-action { padding: 12px 25px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; font-size: 16px; color: white; }
        .btn-print { background: #c00; }
        .btn-back { background: #555; }

        @media print { 
            @page { size: A4 landscape; margin: 5mm; }
            body { padding: 0; background: white; margin: 0; -webkit-print-color-adjust: exact; } 
            .form-container { border: none; box-shadow: none; width: 100%; max-width: 100%; padding: 0; } 
            .no-print, .bottom-actions, .score-select, .clear-btn, .reason-select { display: none !important; } 
            .row-item { min-height: 20px; padding: 1px 4px; }
            
            /* בהדפסה, התיבה תהיה בגובה התוכן */
            .notes-area { border: 1px solid #000; overflow: visible; }
        }
    </style>
</head>
<body>

<div class="form-container">
    <div class="header">
        <h1>צה"ל - משרד הרישוי</h1>
        <h2>תוצאות מבחן מעשי ברכב (נכשל)</h2>
    </div>

    <div class="top-info">
        <div class="vehicle-types">
            <label><input type="checkbox"> פרטי/מסחרי (B)</label>
            <label><input type="checkbox"> משא קל (C1)</label>
            <label><input type="checkbox"> משא כבד (C)</label>
            <label><input type="checkbox"> גורר תומך (E)</label>
            <label><input type="checkbox"> אוטובוס (D)</label>
            <label><input type="checkbox"> אופנוע (A)</label>
            <label><input type="checkbox"> מונית</label>
        </div>
        <div class="field" style="justify-content: center;">
            <label>שם בית הספר לנהיגה:</label>
            <input type="text" id="targetSchool">
        </div>
    </div>

    <div class="details-section">
        <div class="field"><label>שם משפחה:</label><input type="text" id="targetLastName" oninput="updatePageTitle()"></div>
        <div class="field"><label>שם פרטי:</label><input type="text" id="targetFirstName" oninput="updatePageTitle()"></div>
        <div class="field"><label>מס' אישי / ת"ז:</label><input type="text" id="targetID"></div>
        <div class="field"><label>תאריך המבחן:</label><input type="text" id="targetDate"></div>
        <div class="field"><label>שעת המבחן:</label><input type="time" id="targetTime"></div>
        <div class="field"><label>מספר רכב:</label><input type="text" id="targetCar"></div>
    </div>

    <div class="main-grid">
        <div class="column">
            <div class="column-title">א. שליטה ברכב</div>
            <div id="colA"></div>
        </div>
        <div class="column">
            <div class="column-title">ב. התנועה</div>
            <div id="colB"></div>
        </div>
        <div class="column">
            <div class="column-title">ג. הדרך</div>
            <div id="colC"></div>
        </div>
    </div>

    <div class="footer">
        <textarea id="finalNotes" class="notes-area" placeholder="הערות הבוחן יופיעו כאן אוטומטית..." oninput="autoResize(this)"></textarea>
        
        <div class="summary-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="fail-stamp">נכשל</div>
                <div class="field" style="width: 60%;"><label>שם הבוחן:</label><input type="text" id="targetTester"></div>
            </div>
            
            <div class="digital-sig-box">
                <canvas id="sig-canvas" width="250" height="60"></canvas>
                <div class="no-print"><button class="clear-btn" onclick="clearSig()">נקה חתימה</button></div>
                <div style="font-size:10px; font-weight:bold;">חתימת הבוחן</div>
            </div>
        </div>
    </div>
    
    <div class="bottom-actions no-print">
        <button class="btn-action btn-print" onclick="window.print()">הדפס / שמור PDF</button>
        <button class="btn-action btn-back" onclick="window.close()">סגור וחזור לסידור עבודה</button>
    </div>
</div>

<script>
    // --- בנק משפטים חכם ---
    const reasonsDB = {
        // --- עמודה א' - שליטה ---
        "1. התחלת נסיעה": ["דימום מנוע חוזר ונשנה", "השתהות יתר ביציאה מהמקום", "התחלת נסיעה קופצנית/חוסר רגש"],
        "2. שליטה בהגה": ["אחיזת הגה שגויה/רפויה", "חוסר יציבות בנתיב (זיגזג)", "סטייה מנתיב ללא איתות או צורך", "תיקוני הגה מוגזמים"],
        "3. שימוש במצמד/גלישה": ["שימוש יתר/מיותר במצמד", "גלישה מסוכנת לתוך צומת", "העלאת הילוך ללא הפרדה (חריקה)"],
        "4. החלפת הילוכים במועד": ["נסיעה בהילוך לא מתאים למהירות", "איחור בהורדת הילוך בעליה/עצירה", "הורדת עיניים לידית ההילוכים"],
        "5. זינוק בעליה": ["זינוק בעליה - הדרדרות לאחור (התערבות)", "חוסר שליטה בנקודת החיכוך", "דימום מנוע בזינוק"],
        "6. שימוש בבלם רגל/יד": ["בלימה פתאומית ללא צורך", "בלימה מאוחרת מידי", "אי שחרור בלם יד מלא"],
        "7. שליטה כללית ברכב": ["חוסר ביטחון בתפעול הרכב", "נהיגה מהוססת ואיטית ללא צורך"],
        "8. איתות": ["אי מתן איתות בפניות/מעבר נתיב", "איתות לצד הפוך", "איתות מאוחר מידי"],
        "9. נסיעה לאחור (חניה)": [
            "חניה במקביל ללא הסתכלות במראה השמאלית",
            "חניה בניצב ללא הסתכלות במראה השמאלית",
            "עליה על מדרכה במהלך חניה לאחור",
            "חוסר התמצאות במרחב/יותר מידי תיקונים",
            "סיכון רכבים חונים/עוברי דרך"
        ],
        "10. עצירת מטרה": ["עצירה לא מדויקת בקו עצירה", "גלישה מעבר לקו העצירה"],
        "11. שימוש בבלמי האטה": ["אי שימוש בבלם עזר בירידה"],
        "12. מחוונים ואזהרה": ["התעלמות מנורות אזהרה"],
        "13. אביזרי בטיחות": ["אי חגירת חגורה", "אי כיוון מראות/מושב"],
        "14. נסיעה לאחור בזווית": ["סטייה מהנתיב בנסיעה לאחור"],
        "15. התרת ורתימת גרור": ["סדר פעולות שגוי/לא בטיחותי"],

        // --- עמודה ב' - תנועה ---
        "1. זהירות": [
            "פניה בצומת קמץ ללא האטה ובדיקה מספקת (קלות ראש)",
            "נהיגה בחוסר זהירות כללי", 
            "חוסר תשומת לב למתרחש בדרך"
        ],
        "2. הסתכלות": [
            "הנבחן מתקרב למעגל ויוצא ללא בדיקה לימין/מראות",
            "חציית צמתים ללא בדיקה מוקדמת בזרועות הצומת",
            "מבט מקובע לפנים/אי סריקת צמתים"
        ],
        "3. שימוש במראות": [
            "פניה ימינה ללא בדיקת מראה ימנית (לפני/במהלך/אחרי)",
            "מעבר לנתיב שמאל ללא בדיקת מראה שמאלית",
            "אי שימוש במראות לפני בלימה/פניה"
        ],
        "4. השתלבות בתנועה": [
            "הנבחן ניסה להשתלב לאחר פניה ימינה וגרם לרכב להאט/לסטות",
            "ניסיון להשתלב בתנועה בכביש בין-עירוני בצורה מסוכנת",
            "השתלבות מסוכנת/גרימת הפרעה לתנועה",
            "נתיב מסתיים - אי בדיקת מראות והשתלבות מאוחרת"
        ],
        "5. מתן זכות קדימה": [
            "הנבחן לא מבחין בתנועה משתלבת מימין לאחר פניה שמאלה",
            "אי מתן זכות קדימה לרכב הבא מימין", 
            "כניסה לצומת לא פנוי"
        ],
        "6. מהירות": ["נסיעה במהירות מופרזת לתנאי הדרך", "נסיעה איטית מידי המעכבת תנועה"],
        "7. קצב נסיעה": ["קצב נסיעה איטי בכביש בין-עירוני", "עיכוב התנועה שלא לצורך"],
        "8. שמירת רווח": ["הצמדות מסוכנת לרכב מלפנים", "אי שמירת רווח צד"],
        "9. אומדן רוחב": [
            "התקרבות מסוכנת לרכבים חונים מימין (התערבות)",
            "נסיעה קרובה מידי למדרכה"
        ],
        "10. עקיפות/נאקף": [
            "עקיפת רכב עומד ללא בדיקת מראה ימנית בחזרה",
            "לא שם לב שנעקף ולא איפשר חזרה (האצה)",
            "עקיפה בדרך לא פנויה/מסוכנת"
        ],
        "11. נהיגת לילה/אורות": ["אי הדלקת אורות/סינוור"],
        "12. ירידה לשול": ["ירידה מסוכנת לשול/חזרה לא זהירה"],

        // --- עמודה ג' - הדרך ---
        "1. פניות ימינה": [
            "פניה ימינה בקשת רחבה וגלישה לנתיב נגדי (התערבות)",
            "עליה על מדרכה בפניה ימינה",
            "כניסה לנתיב לא נכון בפניה"
        ],
        "2. פניות שמאלה": [
            "ניסיון פניה שמאלה לנתיב הנגדי (התערבות)",
            "פניה שמאלה בקשת קצרה מידי (סיכון אי תנועה/תמרור)",
            "עליה על אי תנועה בפניה שמאלה",
            "פניה שמאלה לחד סטרי - לא לנתיב השמאלי",
            "פניה שמאלה מחד סטרי - לא מהצד השמאלי",
            "ניסיון לפנות שמאלה מנתיב לא נכון"
        ],
        "3. מיקום במפגשים": ["עמידה במקום המפריע לתנועה בצומת"],
        "4. משמעת בנתיבים": ["הנבחן לא חוזר לנתיב הימני לאחר פניה/עקיפה", "סטייה מנתיב הנסיעה", "נסיעה על קו ההפרדה"],
        "5. ציות לתמרורים": ["אי עצירה בתמרור עצור (התערבות)", "אי ציות לתמרור אין כניסה/חץ"],
        "6. ציות לרמזורים": ["ניסיון לעבור צומת באור אדום (התערבות)", "עצירה אחרי קו עצירה ברמזור"],
        "7. נסיעה בימין הדרך": ["אי היצמדות לימין בכביש דו-סטרי", "נסיעה בשמאל ללא צורך"],
        "8. דרך שאינה עירונית": ["נהיגה לא מותאמת לדרך בין-עירונית"],
        "9. התייחסות להולכי רגל": ["אי מתן זכות קדימה להולך רגל במעבר חציה (התערבות)", "סיכון הולכי רגל"],
        "10. נתיב האצה/האטה": ["כניסה לא זהירה מנתיב האצה", "בלימה בנתיב נסיעה לפני נתיב האטה"],
        "11. נהיגה בדרך צרה": [
            "ניסיון פניה שמאלה לנתיב נגדי בדרך צרה (התערבות)",
            "חוסר זהירות במפגש עם רכב ממול"
        ],
        "12. כביש רטוב": ["נסיעה מהירה מידי לתנאי האחיזה"]
    };

    const dataA = Object.keys(reasonsDB).slice(0, 15);
    const dataB = Object.keys(reasonsDB).slice(15, 27);
    const dataC = Object.keys(reasonsDB).slice(27);

    // פונקציה לבניית העמודות
    function renderColumn(id, list) {
        const container = document.getElementById(id);
        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'row-item';
            
            // יצירת רשימת הסיבות
            let options = `<option value="">בחר פירוט...</option>`;
            if (reasonsDB[item]) {
                reasonsDB[item].forEach(reason => {
                    options += `<option value="${reason}">${reason}</option>`;
                });
            }

            div.innerHTML = `
                <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                    <span class="label-text">${item}</span>
                    <select class="reason-select" id="reason-${item}" onchange="updateNotes()">
                        ${options}
                        <option value="אחר">הקלדה ידנית / אחר</option>
                    </select>
                </div>
                <select class="score-select no-print" onchange="markIcon(this)">
                    <option value="">בחר</option>
                    <option value="v">טוב (✓)</option>
                    <option value="x">רע (X)</option>
                    <option value="ox">הפקעה (⊗)</option>
                </select>
                <div class="visual-box"></div>
            `;
            container.appendChild(div);
        });
    }

    function markIcon(sel) {
        const box = sel.nextElementSibling;
        const rowItem = sel.parentElement;
        const reasonSelect = rowItem.querySelector('.reason-select');
        
        const val = sel.value;
        box.innerHTML = '';
        
        if (val === 'v') {
            box.innerHTML = '<span class="v-mark">✓</span>';
            reasonSelect.style.display = 'none';
            reasonSelect.value = "";
        }
        else if (val === 'x') {
            box.innerHTML = '<span class="x-mark">✕</span>';
            reasonSelect.style.display = 'block';
        }
        else if (val === 'ox') {
            box.innerHTML = '<div class="ox-mark">✕</div>';
            reasonSelect.style.display = 'block';
        } else {
            reasonSelect.style.display = 'none';
            reasonSelect.value = "";
        }
        updateNotes();
    }

    // פונקציה להתאמת גובה תיבת הטקסט אוטומטית
    function autoResize(textarea) {
        textarea.style.height = 'auto'; // איפוס הגובה
        textarea.style.height = (textarea.scrollHeight + 5) + 'px'; // הגדרה לגובה התוכן
    }

    // פונקציה שבונה את ההערות הסופיות
    function updateNotes() {
        const selects = document.querySelectorAll('.reason-select');
        let notesText = "";
        
        selects.forEach(sel => {
            if (sel.style.display !== 'none' && sel.value && sel.value !== "") {
                // הסרת המספר מתחילת שם הסעיף
                const rawLabel = sel.parentElement.querySelector('.label-text').innerText;
                const cleanLabel = rawLabel.replace(/^\d+\.\s*/, ''); // מוחק "1. ", "10. " וכו'
                const reason = sel.value;
                
                if (reason === "אחר") {
                    notesText += `• ${cleanLabel}: \n`;
                } else {
                    notesText += `• ${cleanLabel}: ${reason}\n`;
                }
            }
        });

        const notesArea = document.getElementById('finalNotes');
        notesArea.value = notesText;
        autoResize(notesArea); // הרחבת התיבה
    }

    // הפעלת בניית העמודות
    renderColumn('colA', dataA);
    renderColumn('colB', dataB);
    renderColumn('colC', dataC);

    // חתימה ודברים נוספים
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function getPos(e) {
        const r = canvas.getBoundingClientRect();
        return { 
            x: (e.clientX || e.touches[0].clientX) - r.left, 
            y: (e.clientY || e.touches[0].clientY) - r.top 
        };
    }

    ['mousedown', 'touchstart'].forEach(evt => 
        canvas.addEventListener(evt, e => { drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); if(evt=='touchstart') e.preventDefault(); })
    );
    ['mousemove', 'touchmove'].forEach(evt => 
        canvas.addEventListener(evt, e => { if(!drawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); if(evt=='touchmove') e.preventDefault(); })
    );
    ['mouseup', 'touchend'].forEach(evt => canvas.addEventListener(evt, () => drawing = false));

    function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function updatePageTitle() {
        const first = document.getElementById('targetFirstName').value;
        const last = document.getElementById('targetLastName').value;
        if(first || last) {
            document.title = "כישלון - " + first + " " + last;
        }
    }

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('school')) document.getElementById('targetSchool').value = urlParams.get('school');
        if(urlParams.has('id')) document.getElementById('targetID').value = urlParams.get('id');
        if(urlParams.has('car')) document.getElementById('targetCar').value = urlParams.get('car');
        if(urlParams.has('date')) document.getElementById('targetDate').value = urlParams.get('date');
        if(urlParams.has('time')) document.getElementById('targetTime').value = urlParams.get('time');
        if(urlParams.has('tester')) document.getElementById('targetTester').value = urlParams.get('tester');

        if(urlParams.has('name')) {
            const fullName = urlParams.get('name').trim();
            const firstSpaceIndex = fullName.indexOf(' ');
            if (firstSpaceIndex > 0) {
                document.getElementById('targetFirstName').value = fullName.substring(0, firstSpaceIndex);
                document.getElementById('targetLastName').value = fullName.substring(firstSpaceIndex + 1);
            } else {
                document.getElementById('targetFirstName').value = fullName;
            }
            updatePageTitle();
        }
    };
</script>

</body>
</html>