<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™×“×•×¨ ×¢×‘×•×“×” ×•×“×•×— ×‘×•×—×Ÿ</title>
    <style>
        body { background-color: #525659; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 10px; display: flex; justify-content: center; }
        .a4-page { background-color: white; width: 210mm; min-height: 297mm; padding: 10mm; box-shadow: 0 0 15px rgba(0,0,0,0.5); box-sizing: border-box; position: relative; }
        
        /* ×”×ª×××” ×œ××¡×š */
        @media screen {
            .a4-page { width: 100%; max-width: 210mm; height: auto; min-height: auto; padding: 10px; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; }
            table { min-width: 600px; }
        }

        /* ×¢×™×¦×•×‘×™× ×›×œ×œ×™×™× */
        .settings-panel { background: #e3f2fd; border: 1px solid #90caf9; padding: 10px; margin-bottom: 20px; border-radius: 5px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; direction: rtl; }
        .settings-panel input, .settings-panel select { width: 100%; padding: 6px; font-size: 14px; font-weight: bold; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .settings-title { grid-column: span 5; font-weight: bold; text-align: center; color: #0d47a1; margin-bottom: 5px; }
        .header-section { text-align: center; margin-bottom: 10px; }
        .main-title { font-size: 20px; margin: 0; font-weight: normal; }
        .sub-title { font-size: 16px; font-weight: bold; margin-top: 3px; }

        /* ×˜×‘×œ××•×ª */
        table { width: 100%; border-collapse: collapse; margin-bottom: 5px; direction: rtl; table-layout: fixed; }
        th, td { border: 1px solid #000; padding: 2px; text-align: center; font-size: 12px; vertical-align: middle; height: 30px; }
        thead th { background-color: #e7e6e6; font-weight: bold; height: auto; padding: 4px; }
        tfoot tr { background-color: #d1e7dd; font-weight: bold; border-top: 2px solid #000; }
        tfoot input { font-weight: bold; color: #000; }
        .grand-total { font-size: 14px; color: #000; background: #badbcc !important; border: 2px solid #0f5132 !important; }

        /* ×©×“×•×ª ×§×œ×˜ */
        input.tbl-input, select.tbl-input { width: 100%; border: none; background: transparent; text-align: center; font-size: 12px; outline: none; font-family: inherit; padding: 0; margin: 0; height: 100%; display: block; }
        select.tbl-input { -webkit-appearance: none; appearance: none; cursor: pointer; }
        input[type="time"] { -webkit-appearance: none; background: transparent; cursor: pointer; position: relative; }
        input[type="time"]::-webkit-calendar-picker-indicator { position: absolute; left: 0; top: 0; width: 20px; height: 100%; opacity: 0.5; cursor: pointer; }
        
        /* ×©×“×” "××—×¨" ×œ×‘×™"×¡ */
        .school-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        input.other-input { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; border: 2px solid #007bff; text-align: center; font-size: 12px; z-index: 10; box-sizing: border-box; }
        .btn-clear-other { display: none; position: absolute; left: 2px; top: 50%; transform: translateY(-50%); background: #ccc; border: none; font-size: 10px; cursor: pointer; z-index: 11; padding: 2px 5px; border-radius: 50%; }

        /* ×›×¤×ª×•×¨ ×¤×ª×™×—×ª ×˜×•×¤×¡ ×™×“× ×™ */
        .btn-open-form { background: #ffc107; border: 1px solid #d39e00; color: black; font-size: 10px; cursor: pointer; padding: 2px 5px; border-radius: 3px; margin-right: 5px; display: none; }

        /* ×”×¢×¨×•×ª ×•×—×ª×™××•×ª */
        .general-notes-box { border: 1px solid #000; padding: 5px; min-height: 50px; margin-top: 10px; display: flex; flex-direction: column; }
        #generalNotes { width: 100%; border: none; resize: none; font-family: inherit; font-size: 12px; background: transparent; outline: none; overflow: hidden; min-height: 25px; }
        .signature-section { display: flex; justify-content: space-between; margin-top: 20px; align-items: flex-end; }
        .sig-box { width: 45%; text-align: center; }
        .tester-details { font-weight: bold; font-size: 12px; line-height: 1.3; white-space: pre-line; min-height: 40px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center;}
        canvas { border: 1px dashed #999; cursor: crosshair; background: #fff; display: block; margin: 0 auto; }

        /* ×›×¤×ª×•×¨×™× ×¨××©×™×™× ×‘×ª×•×š ×”×“×£ */
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            direction: rtl;
        }
        .main-buttons button {
            padding: 8px 15px;
            font-size: 13px;
        }
        .table-actions { display: flex; gap: 10px; margin-bottom: 5px; direction: rtl; }
        button { border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; }
        .btn-print { background-color: #007bff; }
        .btn-reset { background-color: #dc3545; }
        .btn-add { background-color: #28a745; }
        .btn-remove { background-color: #6c757d; }
        .clear-sig-btn { background-color: #6c757d; margin-top: 5px; font-size: 10px; padding: 2px 6px; width: auto; display: inline-block; }
        .btn-pass-list { background-color: #17a2b8; }
        .btn-distribute { background-color: #9c27b0; }

        /* Modal ×—×œ×•×§×ª ×¢×‘×•×“×” */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 20px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; direction: rtl; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #9c27b0; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; color: #9c27b0; font-size: 18px; }
        .modal-close { background: #dc3545; color: white; border: none; font-size: 20px; cursor: pointer; border-radius: 50%; width: 30px; height: 30px; }
        .distribute-section { margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .distribute-section h3 { margin: 0 0 10px 0; font-size: 14px; color: #333; }
        .distribute-checkbox { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
        .distribute-checkbox input[type="checkbox"] { width: 18px; height: 18px; }
        .distribute-result { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 5px; padding: 15px; margin-top: 15px; }
        .distribute-result h3 { color: #2e7d32; margin: 0 0 10px 0; }
        .tester-assignment { background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px; }
        .tester-assignment h4 { margin: 0 0 8px 0; color: #9c27b0; display: flex; justify-content: space-between; }
        .tester-assignment .total { background: #9c27b0; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .tester-assignment ul { margin: 0; padding-right: 20px; }
        .tester-assignment li { margin: 3px 0; }
        .btn-send-assignment { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-top: 5px; }

        /* ××–×•×¨×™ ×¢×–×¨ (Outbox) */
        #outbox-section, #pass-list-section { margin-top: 20px; border-top: 2px dashed #999; padding-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .outbox-item { background: #fff; border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        .outbox-btn-group button { margin-left: 5px; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; color: white; font-size: 12px; }
        .btn-whatsapp { background: #25D366; color: white; margin-bottom: 5px; width: 100%; text-align: center; padding: 10px; font-size: 14px; }
        .btn-delete { background: #dc3545; }

        @media print { 
            body { background: white; padding: 0; margin: 0; }
            .main-buttons, .settings-panel, .table-actions, .clear-sig-btn, #outbox-section, #pass-list-section, .btn-pass-list, .btn-open-form { display: none !important; }
            .a4-page { box-shadow: none; margin: 0; width: 210mm; height: 297mm; padding: 10mm; overflow: hidden; }
            .table-responsive { overflow: visible; display: block; }
            table { min-width: 100%; width: 100%; }
            td, th { height: 22px; padding: 0; } 
            .school-select.hidden-print { display: none; }
            input.other-input.visible-print { display: block; border: none; font-weight: bold; text-align: center;}
            .btn-clear-other { display: none; }
        }
        
        @media screen and (max-width: 768px) {
            body { flex-direction: column; align-items: center; padding: 0; }
            .main-buttons { flex-wrap: wrap; gap: 5px; }
            .main-buttons button { padding: 8px 12px; font-size: 12px; }
            .a4-page { width: 100%; margin: 0; border-radius: 0; }
        }
    </style>
</head>
<body>

<div class="a4-page">
    <div class="main-buttons">
        <button class="btn-print" onclick="saveWithSmartName()">ğŸ–¨ï¸ ×©××•×¨ PDF</button>
        <button class="btn-reset" onclick="resetForm()">ğŸ”„ × ×§×” ×”×›×œ</button>
        <button class="btn-pass-list" onclick="generatePassList()">ğŸ† ×¦×•×¨ ×¨×©×™××•×ª</button>
        <button class="btn-distribute" onclick="openDistributeModal()">ğŸ“Š ×—×œ×§ ×¢×‘×•×“×”</button>
        <button onclick="openShareModal()" style="background: #00897b;">ğŸ“¤ ×©×™×ª×•×£ × ×ª×•× ×™×</button>
    </div>
    <div class="settings-panel">
        <div class="settings-title">×”×’×“×¨×•×ª ×¤×§×•×“×ª ×¢×‘×•×“×”</div>
        <div><label>×™×•×:</label><select id="daySelect" onchange="saveHeader()"><option>×</option><option>×‘</option><option>×’</option><option>×“</option><option>×”</option></select></div>
        <div><label>×ª××¨×™×š:</label><input type="text" id="dateInput" placeholder="dd/mm/yy" oninput="saveHeader(); generateAreaCode()"></div>
        <div><label>××–×•×¨:</label><select id="areaSelect" onchange="handleAreaChange(); generateAreaCode()"><option value="">×‘×—×¨ ××–×•×¨...</option></select></div>
        <div><label>×‘×•×—× ×™×:</label><input type="text" id="testersInput" placeholder="×”×§×œ×“ ×©××•×ª..." oninput="saveHeader(); updateTesterSelects()"></div>
        <div><label>×§×•×“ ××©×•×ª×£:</label><div style="display:flex; gap:3px;"><input type="text" id="areaCode" placeholder="×œ×—×¥ ×œ×™×¦×™×¨×”" oninput="saveHeader()" style="font-weight: bold; color: #1565c0; flex:1;"><button type="button" onclick="generateAreaCode()" style="padding:5px 8px; font-size:12px; cursor:pointer;" title="×¦×•×¨ ×§×•×“ ××•×˜×•××˜×™">ğŸ”„</button></div></div>
    </div>

    <div class="header-section">
        <img src="logo.png" alt="×¡××›×•×ª ×¨×™×©×•×™ ×¦×”×´×œ" style="width: 80px; height: auto; margin-bottom: 5px;">
        <h1 class="main-title" id="dynamicTitle">×¡×™×“×•×¨ ×¢×‘×•×“×” ×œ×™×•× ...</h1>
        <div class="sub-title" id="dynamicTesters">×”×‘×•×—× ×™×: ...</div>
    </div>

    <div class="table-actions">
        <button class="btn-add" onclick="addPlanRow()">+ ×”×•×¡×£ ×©×•×¨×”</button>
        <button class="btn-remove" onclick="removePlanRow()">- ××—×§ ×©×•×¨×”</button>
    </div>

    <div class="table-responsive">
        <table id="planTable">
            <colgroup>
                <col style="width: 4%;"><col style="width: 4%;"><col style="width: 4%;"><col style="width: 4%;"> <!-- × ×›×©×œ: ×¦×‘× ×©×•× ×•×ª ×•××•×¦'×¨ ×§×“"×¦ -->
                <col style="width: 4%;"><col style="width: 4%;"><col style="width: 4%;"><col style="width: 4%;"> <!-- ×¢×‘×¨: ×¦×‘× ×©×•× ×•×ª ×•××•×¦'×¨ ×§×“"×¦ -->
                <col style="width: 6%;"> <!-- ×©×¢×” -->
                <col style="width: 12%;"> <!-- ×”×¢×¨×•×ª -->
                <col style="width: 5%;"> <!-- ×›××•×ª ×‘×¤×•×¢×œ -->
                <col style="width: 5%;"> <!-- ×›××•×ª ×××•×©×¨×ª -->
                <col style="width: 5%;"> <!-- ×›××•×ª ××‘×•×§×©×ª -->
                <col style="width: 8%;"> <!-- ××¡' ×¨×›×‘ -->
                <col style="width: 5%;"> <!-- ×¡×•×’ ×¨×›×‘ -->
                <col style="width: 15%;"> <!-- ×‘×™"×¡ -->
            </colgroup>
            <thead>
                <tr>
                    <th colspan="8">×‘×™×¦×•×¢</th>
                    <th rowspan="2">×©×¢×”</th>
                    <th rowspan="2">×”×¢×¨×•×ª</th>
                    <th colspan="6">×ª×›× ×•×Ÿ</th>
                </tr>
                <tr>
                    <th colspan="4">× ×›×©×œ</th>
                    <th colspan="4">×¢×‘×¨</th>
                    <th>×›××•×ª ×‘×¤×•×¢×œ</th>
                    <th>×›××•×ª ×××•×©×¨×ª</th>
                    <th>×›××•×ª ××‘×•×§×©×ª</th>
                    <th>××¡' ×¨×›×‘</th>
                    <th>×¡×•×’ ×¨×›×‘</th>
                    <th>×‘×™×”"×¡</th>
                </tr>
                <tr style="font-size: 10px;">
                    <th>×¦×‘×</th><th>×©×•× ×•×ª</th><th>×•××•×¦'×¨</th><th>×§×“"×¦</th>
                    <th>×¦×‘×</th><th>×©×•× ×•×ª</th><th>×•××•×¦'×¨</th><th>×§×“"×¦</th>
                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                </tr>
            </thead>
            <tbody id="planningTableBody"></tbody>
            <tfoot>
                <tr>
                    <td><input class="tbl-input" id="sumFailArmy" readonly></td>
                    <td><input class="tbl-input" id="sumFailOther" readonly></td>
                    <td><input class="tbl-input" id="sumFailVoucher" readonly></td>
                    <td><input class="tbl-input" id="sumFailKadatz" readonly></td>
                    <td><input class="tbl-input" id="sumPassArmy" readonly></td>
                    <td><input class="tbl-input" id="sumPassOther" readonly></td>
                    <td><input class="tbl-input" id="sumPassVoucher" readonly></td>
                    <td><input class="tbl-input" id="sumPassKadatz" readonly></td>
                    <td colspan="8" style="text-align: right; padding-right: 10px; font-weight: bold;">
                        ×¡×”"×› ×‘×™×¦×•×¢: ×¢×‘×¨×• <span id="totalPass" style="color: green;">0</span> | × ×›×©×œ×• <span id="totalFail" style="color: red;">0</span> | ×¡×”"×› <span id="totalAll" style="color: blue;">0</span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div style="text-align: right; font-weight: bold; margin: 15px 0 5px 0; border-bottom: 1px solid #000; font-size: 13px;">×‘×•×—× ×™×:</div>
    <div class="table-actions">
        <button class="btn-add" onclick="addTesterRow()">+ ×”×•×¡×£ ×‘×•×—×Ÿ</button>
        <button class="btn-remove" onclick="removeTesterRow()">- ××—×§ ×‘×•×—×Ÿ</button>
    </div>
    <div class="table-responsive">
        <table id="testersTable">
            <colgroup>
                <col style="width: 50%;">
                <col style="width: 25%;">
                <col style="width: 25%;">
            </colgroup>
            <thead>
                <tr>
                    <th>×©× ×‘×•×—×Ÿ</th>
                    <th>×¢×™×¨×•× ×™</th>
                    <th>××•×¤× ×•×¢/×˜×¨×§×˜×•×¨</th>
                </tr>
            </thead>
            <tbody id="testersTableBody"></tbody>
        </table>
    </div>

    <div style="text-align: right; font-weight: bold; margin: 10px 0 3px 0; border-bottom: 1px solid #000; font-size: 13px;">×¤×™×¨×•×˜ × ×‘×—× ×™×:</div>

    <div class="table-responsive">
        <table>
            <colgroup>
                <col style="width: 4%;">  <col style="width: 15%;"> <col style="width: 8%;"> <col style="width: 11%;"> <col style="width: 17%;"> <col style="width: 6%;">  <col style="width: 9%;"> <col style="width: 10%;"> <col style="width: 6%;">  <col style="width: 9%;"> </colgroup>
            <thead>
                <tr>
                    <th>××¡'</th><th>×©× ×‘×™×”"×¡</th><th>××¡' ×¨×›×‘</th><th>×ª.×–</th><th>×©× ×”× ×‘×—×Ÿ</th><th>×“×¨×’×”</th><th>××•×›×œ×•×¡×™×”</th><th>×‘×•×—×Ÿ</th><th>××‘×—×Ÿ</th><th>×ª×•×¦××”</th>
                </tr>
            </thead>
            <tbody id="examTableBody"></tbody>
        </table>
    </div>

    <div class="general-notes-box">
        <strong style="font-size: 12px;">×”×¢×¨×•×ª ×›×œ×œ×™×•×ª:</strong>
        <textarea id="generalNotes" rows="1" oninput="saveNotes(); autoResize(this)"></textarea>
    </div>

    <div class="signature-section">
        <div class="sig-box">
            <div id="testerDetailsDisplay" class="tester-details"></div>
            <div style="border-top: 1px solid #000; width: 80%; margin: 2px auto;"></div>
            <strong>×¤×¨×˜×™ ×‘×•×—×Ÿ ××—×¨××™</strong>
        </div>
        <div class="sig-box">
            <canvas id="sig-canvas" width="180" height="60"></canvas>
            <button class="clear-sig-btn" onclick="clearSig()">× ×§×” ×—×ª×™××”</button>
            <div style="border-top: 1px solid #000; width: 80%; margin: 2px auto;"></div>
            <strong>×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</strong>
        </div>
    </div>

    <div id="pass-list-section" class="no-print" style="display:none;">
        <h3 style="margin:0 0 10px 0; font-size:14px;">ğŸ† ×”×•×“×¢×•×ª ×¢×•×‘×¨×™×</h3>
        <div id="pass-list-buttons"></div>
    </div>

    <div id="outbox-section" class="no-print">
        <h3 style="margin:0 0 10px 0; font-size:14px;">ğŸ“¬ ×“×•××¨ ×™×•×¦×</h3>
        <div id="outbox-list"></div>
        <div style="text-align:center; margin-top:10px;">
            <button onclick="clearOutbox()" style="background:#555;">× ×§×” ×”×™×¡×˜×•×¨×™×”</button>
        </div>
    </div>
</div>

<!-- Modal ×—×œ×•×§×ª ×¢×‘×•×“×” -->
<div class="modal-overlay" id="distributeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“Š ×—×œ×•×§×ª ×¢×‘×•×“×” ×‘×™×Ÿ ×‘×•×—× ×™×</h2>
            <button class="modal-close" onclick="closeDistributeModal()">Ã—</button>
        </div>

        <div class="distribute-section">
            <h3>ğŸ‘¥ ×‘×•×—× ×™× ××©×ª×ª×¤×™×:</h3>
            <div id="testersList"></div>
        </div>

        <div class="distribute-section">
            <h3>âš™ï¸ ×”×’×“×¨×•×ª:</h3>
            <div class="distribute-checkbox">
                <input type="checkbox" id="leadTesterLess" checked>
                <label for="leadTesterLess">×‘×•×—×Ÿ ××—×¨××™ (×¨××©×•×Ÿ ×‘×¨×©×™××”) ××§×‘×œ × ×‘×—×Ÿ ××—×“ ×¤×—×•×ª</label>
            </div>
            <div class="distribute-checkbox">
                <input type="checkbox" id="keepSchoolTogether" checked>
                <label for="keepSchoolTogether">×©××•×¨ ×‘×™×ª ×¡×¤×¨ ××¦×œ ××•×ª×• ×‘×•×—×Ÿ (×× ××¤×©×¨)</label>
            </div>
        </div>

        <div class="distribute-section">
            <h3>ğŸ« ×‘×ª×™ ×¡×¤×¨ ×•×›××•×™×•×ª (××˜×‘×œ×ª ×”×ª×›× ×•×Ÿ):</h3>
            <div id="schoolsList"></div>
            <p style="font-size:12px; color:#666; margin-top:10px;">×¡×”"×› × ×‘×—× ×™×: <strong id="totalExaminees">0</strong></p>
        </div>

        <div style="text-align: center;">
            <button onclick="calculateDistribution()" style="background:#9c27b0; color:white; padding:12px 30px; font-size:16px; border:none; border-radius:5px; cursor:pointer;">
                ğŸ”„ ×—×©×‘ ×—×œ×•×§×”
            </button>
        </div>

        <div class="distribute-result" id="distributeResult" style="display:none;">
            <h3>âœ… ×ª×•×¦××ª ×”×—×œ×•×§×”:</h3>
            <div id="distributionOutput"></div>
        </div>
    </div>
</div>

<!-- Modal ×©×™×ª×•×£ × ×ª×•× ×™× -->
<div class="modal-overlay" id="shareModal">
    <div class="modal-content">
        <div class="modal-header" style="border-color: #00897b;">
            <h2 style="color: #00897b;">ğŸ“¤ ×©×™×ª×•×£ ×•×™×™×‘×•× × ×ª×•× ×™×</h2>
            <button class="modal-close" onclick="closeShareModal()">Ã—</button>
        </div>

        <div class="distribute-section" style="background: #e0f2f1;">
            <h3 style="color: #00695c;">ğŸ“‹ ×§×•×“ ××–×•×¨ ××©×•×ª×£</h3>
            <p style="font-size: 12px; color: #555;">×§×•×“ ×–×” ××©×•×ª×£ ×œ×›×œ ×”×‘×•×—× ×™× ×‘××•×ª×• ×™×•× ×•××–×•×¨:</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="shareAreaCode" readonly style="flex: 1; padding: 12px; font-size: 18px; font-weight: bold; text-align: center; border: 2px solid #00897b; border-radius: 5px; background: #fff;">
                <button onclick="copyAreaCode()" style="background: #00897b; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">ğŸ“‹ ×”×¢×ª×§</button>
            </div>
        </div>

        <div class="distribute-section" style="background: #e3f2fd;">
            <h3 style="color: #1565c0;">ğŸ“¤ ×™×™×¦×•× ×”× ×ª×•× ×™× ×©×œ×™</h3>
            <p style="font-size: 12px; color: #555;">×©×œ×— ××ª ×”× ×ª×•× ×™× ×©×œ×š ×œ×‘×•×—×Ÿ ×”××—×¨××™:</p>
            <div style="margin-bottom: 10px;">
                <label style="font-size: 12px; color: #333;">×©× ×”×‘×•×—×Ÿ ×©×œ×š:</label>
                <select id="exportTesterName" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px;"></select>
            </div>
            <button onclick="exportMyData()" style="width: 100%; background: #2196F3; color: white; padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px;">
                ğŸ“‹ ×”×¢×ª×§ × ×ª×•× ×™× ×œ×©×œ×™×—×”
            </button>
            <div id="exportStatus" style="margin-top: 10px; text-align: center;"></div>
        </div>

        <div class="distribute-section" style="background: #e8f5e9;">
            <h3 style="color: #2e7d32;">ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™× ××‘×•×—× ×™× ××—×¨×™×</h3>
            <p style="font-size: 12px; color: #555;">×”×“×‘×§ ×›××Ÿ × ×ª×•× ×™× ×©×§×™×‘×œ×ª ××‘×•×—× ×™× ××—×¨×™×:</p>
            <textarea id="importDataText" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××‘×•×—×Ÿ ××—×¨..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; font-size: 14px; box-sizing: border-box;"></textarea>
            <button onclick="importTesterData()" style="width: 100%; background: #4CAF50; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 10px;">
                â• ×”×•×¡×£ × ×ª×•× ×™ ×‘×•×—×Ÿ
            </button>
            <div id="importStatus" style="margin-top: 10px; text-align: center;"></div>

            <!-- ×¨×©×™××ª ×‘×•×—× ×™× ×©×™×•×‘××• -->
            <div id="importedTestersList" style="margin-top: 15px;"></div>
        </div>
    </div>
</div>

<script>
    // ×”×’×“×¨×ª ×©× ×—×œ×•×Ÿ ×¨××©×™ ×§×‘×•×¢ - ×—×•×‘×” ×œ×ª×§×©×•×¨×ª ×ª×§×™× ×”
    window.name = "main_dashboard";

    const schoolMap = {
        "×‘××¨ ×©×‘×¢": ["×©×¨×™×™×‘×¨", "×™×•×‘×œ×™", "×¢×œ ×’×œ×’×œ×™×", "×™×—×“", "××™×¦×™×§", "×‘.×” 6930", "×œ×™×™×Ÿ ×‘×”×“ 6", "××™×—×•×“", "×—×”\"×"],
        "××•×¤×§×™×": ["×‘.×” 6930", "××•×¤×§×™×", "×©×™ ××•×¤×§×™×"],
        "× ×ª×™×‘×•×ª": ["×©×™ ××•×¤×§×™×", "× ×ª×™×‘×•×ª"],
        "×“×™××•× ×”": ["×¢×œ ×’×œ×’×œ×™×", "×“×™××•× ×”", "×¢×™×•×Ÿ"],
        "××©×§×œ×•×Ÿ": ["××™×—×•×“", "××©×§×œ×•×Ÿ", "×‘.×” 6930"],
        "×§×¨×™×ª ×’×ª": ["×“× ×™", "×§×¨×™×ª ×’×ª"],
        "××©×“×•×“": ["×–×”×‘", "××©×“×•×“"],
        "×œ×•×“": ["×‘.×” 6920", "××™×™×œ×•×Ÿ", "×™×•×‘×œ×™", "×¢×œ ×’×œ×’×œ×™×"],
        "×‘×™×ª × ×‘××œ×œ×”": ["×‘.×” 6920", "×¢×™×•×Ÿ", "×‘×™×ª × ×‘××œ×œ×”"],
        "×©×•×”×": ["×‘.×” 6920"],
        "×¦×¨×™×¤×™×Ÿ": ["×‘×”×“ 6", "×¨×™×©×•×™"],
        "×¨×—×•×‘×•×ª": ["×™×•×‘×œ×™", "×¨×—×•×‘×•×ª"],
        "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ": ["×©×¢×¨ ×¨××©×•×Ÿ", "×©×¨×™×™×‘×¨", "×©×¨×™×™×‘×¨ ××•×¤× ×•×¢×™×"],
        "×™×¤×•": ["×.×¡×œ×¢", "×™×—×“×™×•", "×¨×™×©×•×™", "×©×¨×™×™×‘×¨", "××™×—×•×“", "×™×¤×• ×¢×™×•× ×™"],
        "×ª×œ ××‘×™×‘": ["××™×—×•×“", "×©×¨×™×™×‘×¨"],
        "×¤×ª×— ×ª×§×•×•×”": ["×§×¨×Ÿ", "××“×™", "×©×¨×™×™×‘×¨", "×˜×œ", "××“×¨"],
        "×”×“×¨ ×™×•×¡×£": ["×’×•×œ×Ÿ", "×’×•×¨ ××¨×™×”", "×©×¨×™×™×‘×¨"],
        "× ×ª× ×™×”": ["××•×¨×Ÿ ×ª××™×¨", "×©×’×™×", "×©×¨×™×™×‘×¨"],
        "×—×“×¨×”": ["××•×˜×•", "× ×ª×™×‘", "×©×¨×™×™×‘×¨"],
        "×›×¤×¨ ×¡×‘×": ["×©×¨×™×™×‘×¨", "×˜×•×‘", "×”×“×¨×›×™×"],
        "×—×™×¤×”": ["× ×ª×™×‘", "××•××Ÿ", "×—×™×¤×”", "×‘.×” 6910"],
        "×§×¨×™×ª ×—×™×™×": ["×”×§×¨×™×”", "×’×œ ×™×¨×•×§"],
        "×¢×›×•": ["××¨×’××Ÿ", "×¡××™×¨", "× ×ª×™×‘×™ ×”×’×œ×™×œ"],
        "×¢×¤×•×œ×”": ["×”×—××™×©×”", "×œ×™×Ÿ", "×‘.×” 6910", "×™×”×‘", "×©×¨×™×™×‘×¨"],
        "×‘×™×ª ×©××Ÿ": ["×’×œ×‘×•×¢"],
        "×˜×‘×¨×™×”": ["×”××•×Ÿ"],
        "×§×¨×™×ª ×©××•× ×”": ["×¨×•×××” ×’×œ×™×œ", "× ××¨×•×“ ×¡×¢×¨"],
        "×™×¨×•×©×œ×™×": ["×©×¨×™×™×‘×¨", "×“×¨×›×™×", "×œ×’ ×™×¨×•×©×œ×™×", "×¢×œ ×’×œ×’×œ×™×", "×¢×•×–"],
        "×‘×”×œ×¥": ["×˜×¨×§×˜×•×¨ ×¢×™×•× ×™", "×˜×¨×§×˜×•×¨ ××¢×©×™", "×‘×”×“ 14"],
        "×œ×’ ×ª×œ×©": ["×ª×œ×© ×¢×™×•× ×™"],
        "×‘×™×¡×˜ 21": ["×‘×™×¡×˜"]
    };
    
    const testersDB = { "×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ": "×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' 3604" };
    const vehicleTypes = ['','1','A1','A','B','C1','C','E','D'];
    const popTypes = ['','×§×“"×¦','×•××•×¦\'×¨','×¦×‘×','×¤×¨×˜×™/××—×¨'];
    
    let planRowCount = 0;

    window.onload = function() {
        initAreaSelect();
        const savedAreaIdx = localStorage.getItem('header_area_idx');
        if(savedAreaIdx) document.getElementById('areaSelect').selectedIndex = savedAreaIdx;
        handleAreaChange(false); 
        if(localStorage.getItem('header_day')) document.getElementById('daySelect').value = localStorage.getItem('header_day');
        if(localStorage.getItem('header_date')) document.getElementById('dateInput').value = localStorage.getItem('header_date');
        if(localStorage.getItem('header_testers')) document.getElementById('testersInput').value = localStorage.getItem('header_testers');
        if(localStorage.getItem('general_notes')) {
            const notesEl = document.getElementById('generalNotes');
            notesEl.value = localStorage.getItem('general_notes');
            autoResize(notesEl);
        }
        updateHeader();
        initTables();
        loadDataIntoTables();
        initSignature();
        renderOutbox();
        loadImportedTesters();
        // ×˜×¢×Ÿ ×§×•×“ ××–×•×¨ - ×× ×©××•×¨ ×•×ª×§×£, ×”×©×ª××© ×‘×•. ××—×¨×ª ×¦×•×¨ ××•×˜×•××˜×™×ª
        const savedAreaCode = localStorage.getItem('header_area_code');
        if(savedAreaCode && savedAreaCode.trim()) {
            document.getElementById('areaCode').value = savedAreaCode;
        }
        // ×ª××™×“ × ×¡×” ×œ×™×¦×•×¨ ×§×•×“ ×× ××™×Ÿ
        if(!document.getElementById('areaCode').value) {
            generateAreaCode();
        }
    };

    function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight + 5) + 'px'; }

    function initTables() {
        const savedPlanCount = parseInt(localStorage.getItem('plan_rows_count')) || 4;
        const planBody = document.getElementById('planningTableBody');
        planBody.innerHTML = '';
        for(let i=0; i<savedPlanCount; i++) addPlanRow(false);

        // ×˜×‘×œ×ª ×‘×•×—× ×™×
        const savedTesterCount = parseInt(localStorage.getItem('tester_rows_count')) || 1;
        const testerBody = document.getElementById('testersTableBody');
        testerBody.innerHTML = '';
        for(let i=0; i<savedTesterCount; i++) addTesterRow(false);

        const examBody = document.getElementById('examTableBody');
        examBody.innerHTML = '';
        const typeOptions = vehicleTypes.map(v => `<option value="${v}">${v}</option>`).join('');
        const popOptions = popTypes.map(v => `<option value="${v}">${v}</option>`).join('');
        let testNumOptions = '<option></option>';
        for(let j=1; j<=10; j++) testNumOptions += `<option>${j}</option>`;

        for(let i=1; i<=10; i++) {
            const rowHtml = `<tr>
                <td>${i}</td>
                <td>${createSchoolCell()}</td>
                <td><select class="tbl-input exam-input vehicle-num-select"><option value=""></option></select></td>
                <td><input class="tbl-input exam-input"></td>
                <td><input class="tbl-input exam-input"></td>
                <td><select class="tbl-input exam-input grade-select">${typeOptions}</select></td>
                <td><select class="tbl-input exam-input">${popOptions}</select></td>
                <td><select class="tbl-input exam-input exam-tester-select" onchange="updateTesterCounts()"><option value=""></option></select></td>
                <td><select class="tbl-input exam-input">${testNumOptions}</select></td>
                <td>
                    <div style="display:flex; align-items:center; justify-content:center;">
                        <button class="btn-open-form" onclick="openFailForm(this)" title="×¤×ª×— ×˜×•×¤×¡ ×§×™×™×">ğŸ“</button>
                        <select class="tbl-input exam-input result-select" onchange="checkFail(this)">
                            <option></option><option>×¢×‘×¨</option><option value="× ×›×©×œ">× ×›×©×œ</option>
                        </select>
                    </div>
                </td>
            </tr>`;
            examBody.insertAdjacentHTML('beforeend', rowHtml);
        }
        updateExamTesterSelects();
        refreshAllSchoolSelects();
        bindEvents();
    }

    // ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ××ª ×›×œ ×”××™×“×¢ ××˜×‘×œ×ª ×”×ª×›× ×•×Ÿ ×œ×¤×™ ×©× ×‘×™×ª ×¡×¤×¨
    function getPlanDataBySchool(schoolName) {
        const planRows = document.querySelectorAll('#planningTableBody tr');
        const results = [];

        planRows.forEach(row => {
            const schoolSelect = row.querySelector('.school-select');
            const otherInput = row.querySelector('.school-other');
            let rowSchoolName = schoolSelect?.value || '';
            if(rowSchoolName === 'other' && otherInput) {
                rowSchoolName = otherInput.value;
            }

            if(rowSchoolName && rowSchoolName === schoolName) {
                const inputs = row.querySelectorAll('input, select');
                const vehicleNum = row.querySelector('input[placeholder="××¡\' ×¨×›×‘"]')?.value || '';
                const vehicleTypeSelect = row.querySelector('select.plan-input:not(.school-select)');
                const vehicleType = vehicleTypeSelect?.value || '';

                results.push({
                    vehicleNum: vehicleNum,
                    vehicleType: vehicleType
                });
            }
        });

        return results;
    }

    // ×¤×•× ×§×¦×™×” ×©××¢×“×›× ×ª ××¡×¤×¨ ×¨×›×‘ ×•×“×¨×’×” ×›×©×‘×•×—×¨×™× ×‘×™×ª ×¡×¤×¨ ×‘×˜×‘×œ×ª ×”×¤×™×¨×•×˜
    function onExamSchoolChange(selectElement) {
        const row = selectElement.closest('tr');
        const otherInput = row.querySelector('.school-other');
        let schoolName = selectElement.value;
        if(schoolName === 'other' && otherInput) {
            schoolName = otherInput.value;
        }

        const vehicleNumSelect = row.querySelector('.vehicle-num-select');
        const gradeSelect = row.querySelector('.grade-select');

        if(!schoolName || schoolName === 'other') {
            // × ×§×” ××ª ×”×‘×—×™×¨×•×ª
            vehicleNumSelect.innerHTML = '<option value=""></option>';
            return;
        }

        // ×§×‘×œ ××™×“×¢ ××˜×‘×œ×ª ×”×ª×›× ×•×Ÿ
        const planData = getPlanDataBySchool(schoolName);

        if(planData.length === 0) {
            vehicleNumSelect.innerHTML = '<option value=""></option>';
            return;
        }

        // ×‘× ×” ×¨×©×™××ª ××¡×¤×¨×™ ×¨×›×‘
        const uniqueVehicles = [...new Set(planData.map(p => p.vehicleNum).filter(v => v))];
        let vehicleOptions = '<option value=""></option>';
        uniqueVehicles.forEach(v => {
            vehicleOptions += `<option value="${v}">${v}</option>`;
        });
        vehicleNumSelect.innerHTML = vehicleOptions;

        // ×× ×™×© ×¨×§ ××¡×¤×¨ ×¨×›×‘ ××—×“, ×‘×—×¨ ××•×ª×• ××•×˜×•××˜×™×ª
        if(uniqueVehicles.length === 1) {
            vehicleNumSelect.value = uniqueVehicles[0];
        }

        // ×¢×“×›×Ÿ ×“×¨×’×” ×œ×¤×™ ×”×¨××©×•×Ÿ (××• ×× ×™×© ×¨×§ ××—×“)
        if(planData.length >= 1 && planData[0].vehicleType) {
            gradeSelect.value = planData[0].vehicleType;
        }

        saveExamData();
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×“×¨×’×” ×›×©×‘×•×—×¨×™× ××¡×¤×¨ ×¨×›×‘
    function onVehicleNumChange(selectElement) {
        const row = selectElement.closest('tr');
        const schoolSelect = row.querySelector('.school-select');
        const otherInput = row.querySelector('.school-other');
        let schoolName = schoolSelect?.value || '';
        if(schoolName === 'other' && otherInput) {
            schoolName = otherInput.value;
        }

        const vehicleNum = selectElement.value;
        const gradeSelect = row.querySelector('.grade-select');

        if(!schoolName || !vehicleNum) return;

        // ××¦× ××ª ×”×“×¨×’×” ×”××ª××™××” ×œ×©×™×œ×•×‘ ×‘×™×ª ×¡×¤×¨ + ××¡×¤×¨ ×¨×›×‘
        const planRows = document.querySelectorAll('#planningTableBody tr');
        planRows.forEach(planRow => {
            const planSchoolSelect = planRow.querySelector('.school-select');
            const planOtherInput = planRow.querySelector('.school-other');
            let planSchoolName = planSchoolSelect?.value || '';
            if(planSchoolName === 'other' && planOtherInput) {
                planSchoolName = planOtherInput.value;
            }

            const planVehicleNum = planRow.querySelector('input[placeholder="××¡\' ×¨×›×‘"]')?.value || '';

            if(planSchoolName === schoolName && planVehicleNum === vehicleNum) {
                const vehicleTypeSelect = planRow.querySelector('select.plan-input:not(.school-select)');
                if(vehicleTypeSelect?.value) {
                    gradeSelect.value = vehicleTypeSelect.value;
                }
            }
        });

        saveExamData();
    }

    function bindEvents() {
        document.querySelectorAll('.plan-input').forEach(el => el.addEventListener('input', savePlanData));
        document.querySelectorAll('.exam-input').forEach(el => el.addEventListener('input', saveExamData));
        document.querySelectorAll('.tester-input').forEach(el => el.addEventListener('input', saveTesterData));
        document.querySelectorAll('.school-select').forEach(el => el.addEventListener('change', (e) => {
            toggleOtherInput(e.target);
            saveAllData();
            // ×× ×–×” ×‘×˜×‘×œ×ª ×”×¤×™×¨×•×˜, ×¢×“×›×Ÿ ××¡×¤×¨ ×¨×›×‘ ×•×“×¨×’×”
            if(e.target.closest('#examTableBody')) {
                onExamSchoolChange(e.target);
            }
        }));
        document.querySelectorAll('.school-other').forEach(el => el.addEventListener('input', (e) => {
            saveAllData();
            // ×× ×–×” ×‘×˜×‘×œ×ª ×”×¤×™×¨×•×˜, ×¢×“×›×Ÿ ××¡×¤×¨ ×¨×›×‘ ×•×“×¨×’×”
            if(e.target.closest('#examTableBody')) {
                const row = e.target.closest('tr');
                const schoolSelect = row.querySelector('.school-select');
                onExamSchoolChange(schoolSelect);
            }
        }));
        // ×¢×“×›×•×Ÿ ×“×¨×’×” ×›×©×‘×•×—×¨×™× ××¡×¤×¨ ×¨×›×‘
        document.querySelectorAll('.vehicle-num-select').forEach(el => el.addEventListener('change', (e) => {
            onVehicleNumChange(e.target);
        }));
        // ×¢×“×›×•×Ÿ ×¡×¤×™×¨×ª × ×‘×—× ×™× ×›×©××¢×“×›× ×™× ×©× × ×‘×—×Ÿ
        document.querySelectorAll('#examTableBody input.exam-input').forEach(el => {
            el.addEventListener('input', () => {
                setTimeout(updateTesterCounts, 100); // ×¢×“×›×Ÿ ××—×¨×™ ×§×¦×ª ×–××Ÿ
            });
        });
    }

    function saveAllData() { savePlanData(); saveExamData(); }
    function savePlanData() {
        const inputs = document.querySelectorAll('#planningTableBody input, #planningTableBody select');
        const vals = Array.from(inputs).map(el => el.value);
        localStorage.setItem('data_plan_table', JSON.stringify(vals));
    }
    function saveExamData() {
        const inputs = document.querySelectorAll('#examTableBody input, #examTableBody select');
        const vals = Array.from(inputs).map(el => el.value);
        localStorage.setItem('data_exam_table', JSON.stringify(vals));
    }
    function saveHeader() {
        updateHeader();
        localStorage.setItem('header_day', document.getElementById('daySelect').value);
        localStorage.setItem('header_date', document.getElementById('dateInput').value);
        localStorage.setItem('header_testers', document.getElementById('testersInput').value);
        localStorage.setItem('header_area_code', document.getElementById('areaCode').value);
    }
    function saveNotes() { localStorage.setItem('general_notes', document.getElementById('generalNotes').value); }

    function loadDataIntoTables() {
        const planData = JSON.parse(localStorage.getItem('data_plan_table'));
        if (planData) {
            const planInputs = document.querySelectorAll('#planningTableBody input, #planningTableBody select');
            planInputs.forEach((el, i) => {
                if (i < planData.length) {
                    el.value = planData[i];
                    if(el.classList.contains('school-select') && el.value === 'other') toggleOtherInput(el);
                }
            });
        }
        const examData = JSON.parse(localStorage.getItem('data_exam_table'));
        if (examData) {
            const examInputs = document.querySelectorAll('#examTableBody input, #examTableBody select');
            examInputs.forEach((el, i) => {
                if (i < examData.length) {
                    el.value = examData[i];
                    if(el.classList.contains('school-select') && el.value === 'other') toggleOtherInput(el);

                    // ×× ×–×” ×‘×—×™×¨×ª ×‘×™×ª ×¡×¤×¨, ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ××¡×¤×¨×™ ×”×¨×›×‘
                    if(el.classList.contains('school-select') && el.value && el.value !== 'other') {
                        const row = el.closest('tr');
                        if(row) {
                            const vehicleNumSelect = row.querySelector('.vehicle-num-select');
                            if(vehicleNumSelect) {
                                const schoolPlanData = getPlanDataBySchool(el.value);
                                const uniqueVehicles = [...new Set(schoolPlanData.map(p => p.vehicleNum).filter(v => v))];
                                let vehicleOptions = '<option value=""></option>';
                                uniqueVehicles.forEach(v => {
                                    vehicleOptions += `<option value="${v}">${v}</option>`;
                                });
                                vehicleNumSelect.innerHTML = vehicleOptions;

                                // ×¢×“×›×Ÿ ×’× ××ª ×”×“×¨×’×” ×œ×¤×™ ×”×¨××©×•×Ÿ
                                const gradeSelect = row.querySelector('.grade-select');
                                if(gradeSelect && schoolPlanData.length > 0 && schoolPlanData[0].vehicleType) {
                                    gradeSelect.value = schoolPlanData[0].vehicleType;
                                }
                            }
                        }
                    }

                    if (el.classList.contains('result-select') && el.value === '× ×›×©×œ') {
                        el.previousElementSibling.style.display = 'inline-block';
                    }
                }
            });
        }

        // ×˜×¢×Ÿ × ×ª×•× ×™ ×‘×•×—× ×™×
        loadTesterData();

        calcTotals();

        // ×¢×“×›×Ÿ ×¨×©×™××•×ª ×‘×•×—× ×™× ×‘×˜×‘×œ×ª ×”×¤×™×¨×•×˜
        updateExamTesterSelects();

        // ×—×©×‘ ×›××•×™×•×ª × ×‘×—× ×™× ×œ×›×œ ×‘×•×—×Ÿ
        setTimeout(updateTesterCounts, 200);
    }

    function initAreaSelect() {
        const sel = document.getElementById('areaSelect');
        sel.innerHTML = '<option value="">×‘×—×¨ ××–×•×¨...</option>';
        Object.keys(schoolMap).sort().forEach(area => { sel.innerHTML += `<option value="${area}">${area}</option>`; });
        sel.innerHTML += `<option value="other">××—×¨...</option>`;
    }

    function handleAreaChange(save = true) {
        if(save) {
            updateHeader();
            localStorage.setItem('header_area_idx', document.getElementById('areaSelect').selectedIndex);
        }
        refreshAllSchoolSelects();
    }

    function refreshAllSchoolSelects() {
        const selectedArea = document.getElementById('areaSelect').value;
        const schools = schoolMap[selectedArea] || [];
        let opts = '<option value=""></option>';
        schools.forEach(s => opts += `<option value="${s}">${s}</option>`);
        opts += '<option value="other">××—×¨...</option>';

        document.querySelectorAll('.school-select').forEach(selectElem => {
            const currentVal = selectElem.value;
            selectElem.innerHTML = opts;
            if (currentVal && (schools.includes(currentVal) || currentVal === 'other')) selectElem.value = currentVal;
            else selectElem.value = "";
            toggleOtherInput(selectElem);
        });
    }

    function toggleOtherInput(selectElem) {
        const inputElem = selectElem.nextElementSibling.nextElementSibling;
        const clearBtn = selectElem.nextElementSibling;
        if(selectElem.value === 'other') {
            inputElem.style.display = 'block';
            selectElem.classList.add('hidden-print');
            inputElem.classList.add('visible-print');
            clearBtn.style.display = 'block';
        } else {
            inputElem.style.display = 'none';
            selectElem.classList.remove('hidden-print');
            inputElem.classList.remove('visible-print');
            clearBtn.style.display = 'none';
        }
    }
    
    function clearOtherInput(btn) {
        const wrapper = btn.parentElement;
        const select = wrapper.querySelector('.school-select');
        const input = wrapper.querySelector('.school-other');
        select.value = ""; input.value = ""; toggleOtherInput(select); saveAllData();
    }

    function createTypeSelect() { return `<select class="tbl-input exam-input" style="font-weight:bold;">${vehicleTypes.map(v => `<option value="${v}">${v}</option>`).join('')}</select>`; }
    function createSchoolCell(isPlan = false) { 
        const cssClass = isPlan ? 'plan-input' : 'exam-input';
        return `<div class="school-wrapper">
            <select class="tbl-input school-select ${cssClass}" style="text-align:right;" onchange="toggleOtherInput(this)"><option value=""></option></select>
            <button class="btn-clear-other" onclick="clearOtherInput(this)">âœ–</button>
            <input type="text" class="tbl-input other-input school-other ${cssClass}" placeholder="×”×§×œ×“ ×©×..." oninput="saveAllData()">
        </div>`; 
    }

    function addPlanRow(save = true) {
        const tbody = document.getElementById('planningTableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input class="tbl-input fail-army plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input fail-other plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input fail-voucher plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input fail-kadatz plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input pass-army plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input pass-other plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input pass-voucher plan-input" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input pass-kadatz plan-input" type="number" oninput="calcTotals()"></td>
            <td><input type="time" class="tbl-input plan-input"></td>
            <td><input class="tbl-input plan-input" placeholder="×”×¢×¨×•×ª"></td>
            <td><input type="number" class="tbl-input count-actual plan-input"></td>
            <td><input type="number" class="tbl-input count-approved plan-input"></td>
            <td><input type="number" class="tbl-input count-requested plan-input"></td>
            <td><input class="tbl-input plan-input" placeholder="××¡' ×¨×›×‘"></td>
            <td>${createTypeSelect().replace('exam-input', 'plan-input')}</td>
            <td>${createSchoolCell(true)}</td>
        `;
        tbody.appendChild(row);
        refreshAllSchoolSelects();
        bindEvents();
        planRowCount = tbody.children.length;
        if(save) { localStorage.setItem('plan_rows_count', planRowCount); savePlanData(); }
    }

    function removePlanRow() {
        const tbody = document.getElementById('planningTableBody');
        if (tbody.children.length > 1) {
            tbody.removeChild(tbody.lastChild);
            planRowCount = tbody.children.length;
            localStorage.setItem('plan_rows_count', planRowCount);
            savePlanData(); calcTotals();
        }
    }

    // ============ TESTERS TABLE ============
    let testerRowCount = 0;

    function addTesterRow(save = true) {
        const tbody = document.getElementById('testersTableBody');
        const row = document.createElement('tr');
        // ×™×¦×™×¨×ª ×¨×©×™××ª ×‘×•×—× ×™× ××”×”×’×“×¨×•×ª
        const testersFromInput = document.getElementById('testersInput').value;
        let testerOptions = '<option value="">×‘×—×¨ ×‘×•×—×Ÿ...</option>';
        if(testersFromInput) {
            testersFromInput.split(',').forEach(t => {
                const name = t.trim();
                if(name) testerOptions += `<option value="${name}">${name}</option>`;
            });
        }
        row.innerHTML = `
            <td><select class="tbl-input tester-input tester-select" onchange="updateTesterCounts()">${testerOptions}</select></td>
            <td><input class="tbl-input tester-input urban-count" type="number" min="0" max="20" oninput="markManualEdit(this)"></td>
            <td><input class="tbl-input tester-input" type="number" min="0" max="20"></td>
        `;
        tbody.appendChild(row);
        testerRowCount = tbody.children.length;
        if(save) { localStorage.setItem('tester_rows_count', testerRowCount); saveTesterData(); }
    }

    // ×¢×“×›×•×Ÿ ×¨×©×™××•×ª ×”×‘×•×—× ×™× ×›×©××©×ª× ×” ×©×“×” ×”×‘×•×—× ×™×
    function updateTesterSelects() {
        const testersFromInput = document.getElementById('testersInput').value;
        let testerOptions = '<option value="">×‘×—×¨ ×‘×•×—×Ÿ...</option>';
        if(testersFromInput) {
            testersFromInput.split(',').forEach(t => {
                const name = t.trim();
                if(name) testerOptions += `<option value="${name}">${name}</option>`;
            });
        }
        document.querySelectorAll('.tester-select').forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = testerOptions;
            if(currentVal) sel.value = currentVal;
        });
        // ×¢×“×›×Ÿ ×’× ××ª ×¨×©×™××ª ×”×‘×•×—× ×™× ×‘×˜×‘×œ×ª ×”×¤×™×¨×•×˜
        updateExamTesterSelects();
    }

    // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×‘×•×—× ×™× ×‘×˜×‘×œ×ª ×¤×™×¨×•×˜ × ×‘×—× ×™×
    function updateExamTesterSelects() {
        const testersFromInput = document.getElementById('testersInput').value;
        let testerOptions = '<option value=""></option>';
        if(testersFromInput) {
            testersFromInput.split(',').forEach(t => {
                const name = t.trim();
                if(name) testerOptions += `<option value="${name}">${name}</option>`;
            });
        }
        document.querySelectorAll('.exam-tester-select').forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = testerOptions;
            if(currentVal) sel.value = currentVal;
        });
    }

    // ×—×™×©×•×‘ ×›××•×™×•×ª × ×‘×—× ×™× ×œ×›×œ ×‘×•×—×Ÿ ×•×¢×“×›×•×Ÿ ×˜×‘×œ×ª ×”×‘×•×—× ×™×
    function updateTesterCounts() {
        // ×¡×¤×•×¨ × ×‘×—× ×™× ×œ×›×œ ×‘×•×—×Ÿ ××˜×‘×œ×ª ×”×¤×™×¨×•×˜
        const testerCounts = {};
        document.querySelectorAll('.exam-tester-select').forEach(sel => {
            const testerName = sel.value;
            if(testerName) {
                // ×‘×“×•×§ ×× ×™×© ×©× × ×‘×—×Ÿ ×‘×©×•×¨×” (×›×“×™ ×œ×¡×¤×•×¨ ×¨×§ ×©×•×¨×•×ª ××œ××•×ª)
                const row = sel.closest('tr');
                const examNameInput = row.querySelectorAll('input.exam-input')[1]; // ×©×“×” ×©× ×”× ×‘×—×Ÿ
                if(examNameInput && examNameInput.value.trim()) {
                    testerCounts[testerName] = (testerCounts[testerName] || 0) + 1;
                }
            }
        });

        // ×¢×“×›×Ÿ ××ª ×¢××•×“×ª "×¢×™×¨×•× ×™" ×‘×˜×‘×œ×ª ×”×‘×•×—× ×™×
        const testerRows = document.querySelectorAll('#testersTableBody tr');
        testerRows.forEach(row => {
            const testerSelect = row.querySelector('.tester-select');
            const urbanInput = row.querySelector('input[type="number"]'); // ×”×¢××•×“×” ×”×©× ×™×™×” - ×¢×™×¨×•× ×™
            if(testerSelect && urbanInput) {
                const testerName = testerSelect.value;
                const count = testerCounts[testerName] || 0;
                // ×¢×“×›×Ÿ ×¨×§ ×× ×”×©×“×” ×¨×™×§ ××• ×× ×™×© ×¢×¨×š ××•×˜×•××˜×™ ×§×•×“×
                if(!urbanInput.dataset.manual || urbanInput.dataset.manual !== 'true') {
                    urbanInput.value = count > 0 ? count : '';
                    urbanInput.dataset.autoValue = count;
                }
            }
        });

        saveExamData();
    }

    // ×¡××Ÿ ×©×”×©×“×” ×¢×•×“×›×Ÿ ×™×“× ×™×ª
    function markManualEdit(input) {
        if(input.value != input.dataset.autoValue) {
            input.dataset.manual = 'true';
        } else {
            input.dataset.manual = 'false';
        }
    }

    function removeTesterRow() {
        const tbody = document.getElementById('testersTableBody');
        if (tbody.children.length > 1) {
            tbody.removeChild(tbody.lastChild);
            testerRowCount = tbody.children.length;
            localStorage.setItem('tester_rows_count', testerRowCount);
            saveTesterData();
        }
    }

    function saveTesterData() {
        const inputs = document.querySelectorAll('#testersTableBody input');
        const vals = Array.from(inputs).map(el => el.value);
        localStorage.setItem('data_testers_table', JSON.stringify(vals));
    }

    function loadTesterData() {
        const data = JSON.parse(localStorage.getItem('data_testers_table'));
        if (data) {
            const inputs = document.querySelectorAll('#testersTableBody input');
            inputs.forEach((el, i) => {
                if (i < data.length) el.value = data[i];
            });
        }
    }

    function calcTotals() {
        // ×¡×™×›×•××™ ×‘×™×¦×•×¢ ×‘×œ×‘×“ - ×¢×‘×¨
        let sumPassArmy = 0, sumPassOther = 0, sumPassVoucher = 0, sumPassKadatz = 0;
        // ×¡×™×›×•××™ ×‘×™×¦×•×¢ ×‘×œ×‘×“ - × ×›×©×œ
        let sumFailArmy = 0, sumFailOther = 0, sumFailVoucher = 0, sumFailKadatz = 0;

        document.querySelectorAll('#planningTableBody tr').forEach(row => {
            // ×¢×‘×¨ (×‘×™×¦×•×¢)
            sumPassArmy += parseInt(row.querySelector('.pass-army')?.value) || 0;
            sumPassOther += parseInt(row.querySelector('.pass-other')?.value) || 0;
            sumPassVoucher += parseInt(row.querySelector('.pass-voucher')?.value) || 0;
            sumPassKadatz += parseInt(row.querySelector('.pass-kadatz')?.value) || 0;
            // × ×›×©×œ (×‘×™×¦×•×¢)
            sumFailArmy += parseInt(row.querySelector('.fail-army')?.value) || 0;
            sumFailOther += parseInt(row.querySelector('.fail-other')?.value) || 0;
            sumFailVoucher += parseInt(row.querySelector('.fail-voucher')?.value) || 0;
            sumFailKadatz += parseInt(row.querySelector('.fail-kadatz')?.value) || 0;
        });

        // ×¢×“×›×Ÿ ×¡×™×›×•××™ ×¢×‘×¨ (×‘×™×¦×•×¢ ×‘×œ×‘×“)
        document.getElementById('sumPassArmy').value = sumPassArmy > 0 ? sumPassArmy : '';
        document.getElementById('sumPassOther').value = sumPassOther > 0 ? sumPassOther : '';
        document.getElementById('sumPassVoucher').value = sumPassVoucher > 0 ? sumPassVoucher : '';
        document.getElementById('sumPassKadatz').value = sumPassKadatz > 0 ? sumPassKadatz : '';
        // ×¢×“×›×Ÿ ×¡×™×›×•××™ × ×›×©×œ (×‘×™×¦×•×¢ ×‘×œ×‘×“)
        document.getElementById('sumFailArmy').value = sumFailArmy > 0 ? sumFailArmy : '';
        document.getElementById('sumFailOther').value = sumFailOther > 0 ? sumFailOther : '';
        document.getElementById('sumFailVoucher').value = sumFailVoucher > 0 ? sumFailVoucher : '';
        document.getElementById('sumFailKadatz').value = sumFailKadatz > 0 ? sumFailKadatz : '';

        // ×¡×™×›×•× ×›×•×œ×œ ×‘×™×¦×•×¢
        const totalPass = sumPassArmy + sumPassOther + sumPassVoucher + sumPassKadatz;
        const totalFail = sumFailArmy + sumFailOther + sumFailVoucher + sumFailKadatz;
        const totalAll = totalPass + totalFail;
        document.getElementById('totalPass').textContent = totalPass;
        document.getElementById('totalFail').textContent = totalFail;
        document.getElementById('totalAll').textContent = totalAll;
    }

    function getRowData(selectElem) {
        const row = selectElem.closest('tr');
        const inputs = row.querySelectorAll('input:not(.other-input).exam-input'); 
        const schoolSel = row.querySelector('.school-select');
        const schoolOther = row.querySelector('.school-other');
        const schoolVal = (schoolSel.value === 'other') ? schoolOther.value : schoolSel.value;
        const carVal = inputs[0].value || '';
        const idVal = inputs[1].value || '';
        const nameVal = inputs[2].value || '';
        const dateVal = document.getElementById('dateInput').value || '';
        const testerVal = document.getElementById('testersInput').value.split(',')[0].trim();
        return { name: nameVal, id: idVal, car: carVal, school: schoolVal, date: dateVal, tester: testerVal };
    }

    function checkFail(selectElem) {
        saveExamData();
        const btn = selectElem.previousElementSibling;
        
        if (selectElem.value === '× ×›×©×œ') {
            btn.style.display = 'inline-block';
            const data = getRowData(selectElem);
            const url = `driving_test.html?name=${encodeURIComponent(data.name)}&id=${encodeURIComponent(data.id)}&car=${encodeURIComponent(data.car)}&school=${encodeURIComponent(data.school)}&date=${encodeURIComponent(data.date)}&tester=${encodeURIComponent(data.tester)}`;
            const winName = 'failWindow_' + (data.id || Math.random());
            window.open(url, winName);
        } else {
            btn.style.display = 'none';
        }
    }

    function openFailForm(btn) {
        const selectElem = btn.nextElementSibling;
        checkFail(selectElem);
    }

    function updateHeader() {
        const day = document.getElementById('daySelect').value;
        const date = document.getElementById('dateInput').value;
        const areaSel = document.getElementById('areaSelect');
        const area = areaSel.options[areaSel.selectedIndex] ? areaSel.options[areaSel.selectedIndex].text : ''; 
        const testers = document.getElementById('testersInput').value;
        const displayArea = (area === '×‘×—×¨ ××–×•×¨...' || !area) ? '_______' : area;
        document.getElementById('dynamicTitle').innerText = `×¡×™×“×•×¨ ×¢×‘×•×“×” ×œ×™×•× ${day} ×œ×ª××¨×™×š ${date} ×œ××–×•×¨ ${displayArea}`;
        document.getElementById('dynamicTesters').innerText = testers ? `×”×‘×•×—× ×™×: ${testers}` : '';
        if(testers) {
            const firstTester = testers.split(',')[0].trim();
            const details = testersDB[firstTester] || firstTester;
            document.getElementById('testerDetailsDisplay').innerText = details;
        } else {
            document.getElementById('testerDetailsDisplay').innerText = '';
        }
    }

    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    function initSignature() {
        function getPos(e) { const r = canvas.getBoundingClientRect(); return { x: (e.clientX || e.touches[0].clientX) - r.left, y: (e.clientY || e.touches[0].clientY) - r.top }; }
        ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, e => { drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); if(evt=='touchstart') e.preventDefault(); }));
        ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, e => { if(!drawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); if(evt=='touchmove') e.preventDefault(); }));
        ['mouseup', 'touchend'].forEach(evt => { canvas.addEventListener(evt, () => { drawing = false; localStorage.setItem('main_signature', canvas.toDataURL()); }); });
        const savedSig = localStorage.getItem('main_signature');
        if(savedSig) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = savedSig; }
    }
    function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); localStorage.removeItem('main_signature'); }

    function renderOutbox() {
        const list = document.getElementById('outbox-list');
        const savedMessages = JSON.parse(localStorage.getItem('whatsapp_outbox')) || [];
        list.innerHTML = '';
        if(savedMessages.length === 0) { list.innerHTML = '<p style="text-align:center; color:#777; font-size:12px;">××™×Ÿ ×”×•×“×¢×•×ª ×××ª×™× ×•×ª</p>'; return; }
        savedMessages.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'outbox-item';
            div.innerHTML = `<div style="font-size:12px;"><strong>${item.name}</strong> <span style="color:#777">(${item.time})</span></div>
                <div class="outbox-btn-group"><button class="btn-whatsapp" onclick="sendSaved(${index})">×©×œ×—</button><button class="btn-delete" onclick="deleteSaved(${index})">××—×§</button></div>`;
            list.appendChild(div);
        });
    }
    function sendSaved(index) {
        const savedMessages = JSON.parse(localStorage.getItem('whatsapp_outbox')) || [];
        const item = savedMessages[index];
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(item.text)}`, '_blank');
    }
    function deleteSaved(index) {
        let savedMessages = JSON.parse(localStorage.getItem('whatsapp_outbox')) || [];
        savedMessages.splice(index, 1);
        localStorage.setItem('whatsapp_outbox', JSON.stringify(savedMessages));
        renderOutbox();
    }
    function clearOutbox() { if(confirm('×œ××—×•×§ ×”×›×œ?')) { localStorage.removeItem('whatsapp_outbox'); renderOutbox(); } }
    function generatePassList() {
        const rows = document.querySelectorAll('#examTableBody tr');
        const passBySchool = {};
        const date = document.getElementById('dateInput').value || '×”×™×•×';
        const areaSelect = document.getElementById('areaSelect');
        const area = areaSelect.options[areaSelect.selectedIndex].text;
        const testerName = document.getElementById('testersInput').value;
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            const schoolSel = inputs[0]; 
            const schoolInput = schoolSel.parentElement.querySelector('.school-other');
            const schoolName = (schoolSel.value === 'other' ? schoolInput.value : schoolSel.value).trim();
            const studentName = inputs[4].value.trim();
            const result = inputs[8].value; 
            if(result === '×¢×‘×¨' && schoolName && studentName) {
                if(!passBySchool[schoolName]) passBySchool[schoolName] = [];
                passBySchool[schoolName].push(studentName);
            }
        });
        if(Object.keys(passBySchool).length === 0) { alert('×œ× × ××¦××• ×ª×œ××™×“×™× ×©×¢×‘×¨×•'); return; }
        const buttonsDiv = document.getElementById('pass-list-buttons');
        buttonsDiv.innerHTML = '';
        for (const [school, students] of Object.entries(passBySchool)) {
            let msg = `*×¨×©×™××ª ×¢×•×‘×¨×™× - ${date} - ${area}*\n`;
            if(testerName) msg += `ğŸ‘®â€â™‚ï¸ *×‘×•×—×Ÿ: ${testerName}*\n`;
            msg += `\nğŸš— *${school}*\n`;
            students.forEach(st => msg += `âœ… ${st}\n`);
            const btn = document.createElement('button');
            btn.className = 'btn-whatsapp';
            btn.style.marginBottom = '5px';
            btn.innerText = `×©×œ×— ×¨×©×™××” ×œ-${school} (${students.length})`;
            btn.onclick = function() { window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank'); };
            buttonsDiv.appendChild(btn);
        }
        document.getElementById('pass-list-section').style.display = 'block';
        document.getElementById('pass-list-section').scrollIntoView({ behavior: 'smooth' });
    }
    function resetForm() { if(confirm('×œ× ×§×•×ª ×”×›×œ?')) { localStorage.clear(); location.reload(); } }
    function saveWithSmartName() {
        const dateVal = document.getElementById('dateInput').value || '×œ×œ×_×ª××¨×™×š';
        const areaSelect = document.getElementById('areaSelect');
        let areaName = (areaSelect.selectedIndex > 0) ? areaSelect.options[areaSelect.selectedIndex].text : '×›×œ×œ×™';
        const safeDate = dateVal.replace(/\//g, '-').replace(/\./g, '-');
        const safeArea = areaName.replace(/["']/g, '');
        document.title = `×¡×™×“×•×¨_×¢×‘×•×“×”_${safeArea}_${safeDate}`;
        window.print();
    }

    // ============ ×—×œ×•×§×ª ×¢×‘×•×“×” ============
    const MAX_PER_TESTER = 10; // ××§×¡×™××•× 10 × ×‘×—× ×™× ×œ×‘×•×—×Ÿ - ×§×‘×•×¢ ×’×œ×•×‘×œ×™
    let currentAssignments = []; // ×œ×©××™×¨×ª ×”×—×œ×•×§×” ×”× ×•×›×—×™×ª ×œ×¢×¨×™×›×” ×™×“× ×™×ª

    function openDistributeModal() {
        // ×˜×¢×Ÿ ×‘×•×—× ×™× ××”×”×’×“×¨×•×ª
        const testersInput = document.getElementById('testersInput').value;
        const testers = testersInput.split(',').map(t => t.trim()).filter(t => t);

        if(testers.length < 2) {
            alert('×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª 2 ×‘×•×—× ×™× ×‘×”×’×“×¨×•×ª ×¤×§×•×“×ª ×¢×‘×•×“×”');
            return;
        }

        // ×”×¦×’ ×¨×©×™××ª ×‘×•×—× ×™× ×¢× checkboxes
        const testersList = document.getElementById('testersList');
        testersList.innerHTML = testers.map((t, i) => `
            <div class="distribute-checkbox">
                <input type="checkbox" id="tester_${i}" value="${t}" checked>
                <label for="tester_${i}">${t} ${i === 0 ? '(××—×¨××™)' : ''}</label>
            </div>
        `).join('');

        // ×˜×¢×Ÿ ×‘×ª×™ ×¡×¤×¨ ×•×›××•×™×•×ª ××˜×‘×œ×ª ×”×ª×›× ×•×Ÿ
        loadSchoolsFromPlan();

        // ××¤×¡ ×ª×•×¦××•×ª ×§×•×“××•×ª
        document.getElementById('distributeResult').style.display = 'none';

        document.getElementById('distributeModal').classList.add('active');
    }

    function closeDistributeModal() {
        document.getElementById('distributeModal').classList.remove('active');
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××©×§×œ ××‘×—×Ÿ ×œ×¤×™ ×“×¨×’×”
    function getTestWeight(vehicleType) {
        if(vehicleType === 'D') return 2; // D × ×—×©×‘ ×›-2 ××‘×—× ×™×
        if(['A', 'A1', 'A2'].includes(vehicleType)) return 1/3; // ××•×¤× ×•×¢ × ×—×©×‘ ×›-1/3 ××‘×—×Ÿ
        return 1; // ×¨×’×™×œ
    }

    function loadSchoolsFromPlan() {
        const schoolsList = document.getElementById('schoolsList');
        const rows = document.querySelectorAll('#planningTableBody tr');
        let schools = [];
        let total = 0;
        let weightedTotal = 0;

        rows.forEach((row, idx) => {
            const schoolSelect = row.querySelector('.school-select');
            const schoolOther = row.querySelector('.school-other');
            const actualInput = row.querySelector('.count-actual');
            const vehicleSelect = row.querySelector('select[class*="plan-input"]:not(.school-select)');
            const timeInput = row.querySelector('input[type="time"]');

            let schoolName = '';
            if(schoolSelect) {
                schoolName = schoolSelect.value === 'other' ? (schoolOther?.value || '') : schoolSelect.value;
            }

            const actual = parseInt(actualInput?.value) || 0;
            const vehicleType = vehicleSelect?.value || '';
            const time = timeInput?.value || '99:99'; // ×× ××™×Ÿ ×©×¢×”, ×©×™× ×‘×¡×•×£

            if(schoolName && actual > 0) {
                const weight = getTestWeight(vehicleType);
                const weightedCount = actual * weight;
                schools.push({
                    name: schoolName,
                    count: actual,
                    type: vehicleType,
                    idx: idx,
                    time: time,
                    weight: weight,
                    weightedCount: weightedCount
                });
                total += actual;
                weightedTotal += weightedCount;
            }
        });

        if(schools.length === 0) {
            schoolsList.innerHTML = '<p style="color:#d32f2f;">××™×Ÿ ×‘×ª×™ ×¡×¤×¨ ×¢× ×›××•×™×•×ª ×‘×˜×‘×œ×ª ×”×ª×›× ×•×Ÿ</p>';
            document.getElementById('totalExaminees').textContent = '0';
            return;
        }

        schoolsList.innerHTML = schools.map((s, i) => {
            let weightInfo = '';
            if(s.type === 'D') weightInfo = ' (Ã—2)';
            else if(['A', 'A1', 'A2'].includes(s.type)) weightInfo = ' (Ã—â…“)';

            return `<div style="display:flex; justify-content:space-between; padding:5px; background:white; margin:3px 0; border-radius:3px; ${s.count > MAX_PER_TESTER ? 'border: 2px solid orange;' : ''}">
                <span>${s.name} ${s.type ? `(${s.type})` : ''}${weightInfo} ${s.time !== '99:99' ? `â°${s.time}` : ''} ${s.count > MAX_PER_TESTER ? 'âš ï¸' : ''}</span>
                <span style="font-weight:bold;">${s.count} × ×‘×—× ×™×</span>
            </div>`;
        }).join('');

        if(schools.some(s => s.count > MAX_PER_TESTER)) {
            schoolsList.innerHTML += `<p style="color:orange; font-size:12px; margin-top:5px;">âš ï¸ ×™×© ×‘×ª×™ ×¡×¤×¨ ×¢× ×™×•×ª×¨ ×-10 × ×‘×—× ×™× - ×™×¤×•×¦×œ×• ×‘×™×Ÿ ×‘×•×—× ×™×</p>`;
        }

        document.getElementById('totalExaminees').textContent = total + ` (××©×•×§×œ×œ: ${weightedTotal.toFixed(1)})`;

        // ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×œ×©×™××•×© ×‘×—×™×©×•×‘
        window.schoolsData = schools;
    }

    function calculateDistribution() {
        // ×§×‘×œ ×‘×•×—× ×™× ×©× ×‘×—×¨×•
        const selectedTesters = [];
        document.querySelectorAll('#testersList input[type="checkbox"]:checked').forEach(cb => {
            selectedTesters.push(cb.value);
        });

        if(selectedTesters.length < 2) {
            alert('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª 2 ×‘×•×—× ×™×');
            return;
        }

        const schools = window.schoolsData || [];
        if(schools.length === 0) {
            alert('××™×Ÿ ×‘×ª×™ ×¡×¤×¨ ×œ×—×œ×•×§×”');
            return;
        }

        const leadTesterLess = document.getElementById('leadTesterLess').checked;

        // ×—×™×©×•×‘ ×¡×”"×› × ×‘×—× ×™× ×•××©×§×œ ××©×•×§×œ×œ
        const totalExaminees = schools.reduce((sum, s) => sum + s.count, 0);
        const totalWeighted = schools.reduce((sum, s) => sum + (s.weightedCount || s.count), 0);
        const numTesters = selectedTesters.length;
        const maxCapacity = numTesters * MAX_PER_TESTER;

        // ×‘×“×™×§×” ×× ×™×© ××¡×¤×™×§ ×‘×•×—× ×™×
        if(totalExaminees > maxCapacity) {
            alert(`âš ï¸ ×™×© ${totalExaminees} × ×‘×—× ×™× ××‘×œ ${numTesters} ×‘×•×—× ×™× ×™×›×•×œ×™× ×œ×‘×—×•×Ÿ ××§×¡×™××•× ${maxCapacity} (10 ×œ×›×œ ×‘×•×—×Ÿ).\n×™×© ×œ×”×•×¡×™×£ ×¢×•×“ ×‘×•×—× ×™× ××• ×œ×”×¤×—×™×ª × ×‘×—× ×™×.`);
            return;
        }

        // ×—×™×©×•×‘ ×™×¢×“ ××©×•×§×œ×œ ×œ×›×œ ×‘×•×—×Ÿ
        const numRegularTesters = numTesters - 1;
        const baseWeightedPerTester = totalWeighted / numTesters;

        let leadWeightedTarget;
        if(leadTesterLess && numTesters > 1) {
            // ×”××—×¨××™ ××§×‘×œ ×¤×—×•×ª - × ×•×¨×™×“ ××©×§×œ ×©×œ ××‘×—×Ÿ 1 ×¨×’×™×œ
            leadWeightedTarget = Math.max(0, baseWeightedPerTester - 1);
        } else {
            leadWeightedTarget = baseWeightedPerTester;
        }

        // ×™×¦×™×¨×ª ××‘× ×” ×”×§×¦××”
        const assignments = selectedTesters.map((name, idx) => {
            return {
                name: name,
                isLead: idx === 0,
                items: [],
                total: 0,
                weightedTotal: 0,
                targetWeighted: idx === 0 ? leadWeightedTarget : (totalWeighted - leadWeightedTarget) / numRegularTesters
            };
        });

        // ××™×™×Ÿ ×‘×ª×™ ×¡×¤×¨ ×œ×¤×™ ×©×¢×” (××•×§×“× ×§×•×“×) ×•××– ×œ×¤×™ ××©×§×œ (×’×“×•×œ ×§×•×“×)
        let workItems = [...schools].sort((a, b) => {
            // ×§×•×“× ×œ×¤×™ ×©×¢×”
            if(a.time !== b.time) return a.time.localeCompare(b.time);
            // ×× ××•×ª×” ×©×¢×”, ×œ×¤×™ ××©×§×œ ×™×•×¨×“
            return (b.weightedCount || b.count) - (a.weightedCount || a.count);
        });

        // ××œ×’×•×¨×™×ª× ×—×œ×•×§×” ××©×•×¤×¨ ×¢× ××©×§×œ×™× ×•×©×¢×•×ª
        workItems.forEach(item => {
            let remaining = item.count;
            const weight = item.weight || 1;

            while(remaining > 0) {
                // ××¦× ××ª ×”×‘×•×—×Ÿ ×”×›×™ ××ª××™×:
                // 1. ×™×© ×œ×• ××§×•× (×œ× ×¢×•×‘×¨ 10)
                // 2. ×”×›×™ ×¨×—×•×§ ××”×™×¢×“ ×”××©×•×§×œ×œ ×©×œ×•
                let bestIdx = -1;
                let bestScore = -Infinity;

                assignments.forEach((a, idx) => {
                    const room = MAX_PER_TESTER - a.total;
                    if(room <= 0) return;

                    // ×¦×™×•×Ÿ = ×›××” ×¨×—×•×§ ××”×™×¢×“ ×”××©×•×§×œ×œ
                    const remainingToTarget = a.targetWeighted - a.weightedTotal;
                    if(remainingToTarget > bestScore) {
                        bestScore = remainingToTarget;
                        bestIdx = idx;
                    }
                });

                if(bestIdx === -1) {
                    // ×× ××™×Ÿ ××§×•× ×œ××£ ××—×“, ×§×— ××ª ××™ ×©×™×© ×œ×• ×”×›×™ ×¤×—×•×ª
                    let minTotal = Infinity;
                    assignments.forEach((a, idx) => {
                        if(a.total < minTotal) {
                            minTotal = a.total;
                            bestIdx = idx;
                        }
                    });
                }

                if(bestIdx === -1) {
                    console.error(`××™×Ÿ ××§×•× ×œ×©××¨ ×”× ×‘×—× ×™× ×-${item.name}`);
                    break;
                }

                // ×›××” × ×‘×—× ×™× ×œ×”×§×¦×•×ª ×œ×‘×•×—×Ÿ ×”×–×”
                const room = MAX_PER_TESTER - assignments[bestIdx].total;
                const toAssign = Math.min(remaining, Math.max(1, room));

                // ×‘×“×•×§ ×× ×›×‘×¨ ×™×© ×¤×¨×™×˜ ×××•×ª×• ×‘×™×ª ×¡×¤×¨ ××¦×œ ×”×‘×•×—×Ÿ ×”×–×”
                const existingItem = assignments[bestIdx].items.find(i =>
                    i.name === item.name && i.type === item.type
                );

                if(existingItem) {
                    existingItem.count += toAssign;
                    existingItem.weightedCount = (existingItem.weightedCount || 0) + toAssign * weight;
                } else {
                    assignments[bestIdx].items.push({
                        name: item.name,
                        count: toAssign,
                        type: item.type,
                        time: item.time,
                        weight: weight,
                        weightedCount: toAssign * weight,
                        original: item.original || item.name
                    });
                }

                assignments[bestIdx].total += toAssign;
                assignments[bestIdx].weightedTotal += toAssign * weight;
                remaining -= toAssign;
            }
        });

        // ××™×™×Ÿ ×¤×¨×™×˜×™× ×‘×›×œ ×‘×•×—×Ÿ ×œ×¤×™ ×©×¢×”
        assignments.forEach(a => {
            a.items.sort((x, y) => (x.time || '99:99').localeCompare(y.time || '99:99'));
        });

        // ×‘×“×™×§×ª ×©×œ××•×ª - ×•×“× ×©×›×œ ×”× ×‘×—× ×™× ×”×•×§×¦×•
        const totalAssigned = assignments.reduce((sum, a) => sum + a.total, 0);
        if(totalAssigned !== totalExaminees) {
            console.error(`×©×’×™××”: ×”×•×§×¦×• ${totalAssigned} ××ª×•×š ${totalExaminees} × ×‘×—× ×™×!`);
        }

        // ×©××•×¨ ×œ×¢×¨×™×›×” ×™×“× ×™×ª
        currentAssignments = assignments;

        // ×”×¦×’ ×ª×•×¦××•×ª
        displayDistribution(assignments);
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××©×š ××‘×—×Ÿ ×‘×“×§×•×ª ×œ×¤×™ ×¡×•×’ ×¨×›×‘
    function getTestDuration(vehicleType) {
        if(vehicleType === 'D') return 40; // D = 2 ××‘×—× ×™× ×¨×’×™×œ×™× = 40 ×“×§×•×ª
        if(['A', 'A1', 'A2'].includes(vehicleType)) return 7; // A = â…“ ××‘×—×Ÿ = ~7 ×“×§×•×ª
        return 20; // ××‘×—×Ÿ ×¨×’×™×œ = 20 ×“×§×•×ª
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×“×§×•×ª ×œ×©×¢×” (×¤×•×¨××˜ HH:MM)
    function addMinutesToTime(timeStr, minutes) {
        if(!timeStr || timeStr === '99:99') return null;
        const [hours, mins] = timeStr.split(':').map(Number);
        const totalMins = hours * 60 + mins + minutes;
        const newHours = Math.floor(totalMins / 60) % 24;
        const newMins = totalMins % 60;
        return `${String(newHours).padStart(2, '0')}:${String(newMins).padStart(2, '0')}`;
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×œ×•×— ×–×× ×™× ×œ×‘×•×—×Ÿ
    function calculateTesterSchedule(items) {
        const schedule = [];
        let currentTime = null;

        // ××™×™×Ÿ ×œ×¤×™ ×©×¢×”
        const sortedItems = [...items].sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

        sortedItems.forEach(item => {
            const startTime = item.time && item.time !== '99:99' ? item.time : currentTime;
            const duration = getTestDuration(item.type) * item.count;
            const endTime = startTime ? addMinutesToTime(startTime, duration) : null;

            schedule.push({
                ...item,
                startTime: startTime,
                endTime: endTime,
                duration: duration
            });

            // ×¢×“×›×Ÿ ×–××Ÿ × ×•×›×—×™ ×œ×¡×™×•× ×‘×™×ª ×”×¡×¤×¨ ×”×–×”
            if(endTime) {
                currentTime = endTime;
            }
        });

        return schedule;
    }

    function displayDistribution(assignments) {
        const output = document.getElementById('distributionOutput');
        const date = document.getElementById('dateInput').value || '';
        const areaSelect = document.getElementById('areaSelect');
        const area = areaSelect.options[areaSelect.selectedIndex]?.text || '';

        let html = '';

        // ×‘×“×™×§×” ×× ×™×© ×—×¨×™×’×” ××”××§×¡×™××•×
        const hasOverflow = assignments.some(a => a.total > MAX_PER_TESTER);
        if(hasOverflow) {
            html += `<div style="background:#ffebee; border:2px solid #f44336; padding:10px; border-radius:5px; margin-bottom:15px;">
                <strong style="color:#c62828;">âš ï¸ ×©×’×™××”: ×™×© ×‘×•×—× ×™× ×¢× ×™×•×ª×¨ ×-10 × ×‘×—× ×™×!</strong><br>
                <span style="font-size:12px;">×™×© ×œ×”×¢×‘×™×¨ ×¤×¨×™×˜×™× ×™×“× ×™×ª ××• ×œ×”×•×¡×™×£ ×‘×•×—× ×™×.</span>
            </div>`;
        }

        assignments.forEach((a, testerIdx) => {
            const isOverLimit = a.total > MAX_PER_TESTER;
            const weightedTotal = a.weightedTotal?.toFixed(1) || a.total;

            // ×—×©×‘ ×œ×•×— ×–×× ×™× ×œ×‘×•×—×Ÿ
            const schedule = calculateTesterSchedule(a.items);

            // ×—×©×‘ ×–××Ÿ ×¡×™×•× ×›×•×œ×œ
            const lastItem = schedule[schedule.length - 1];
            const totalEndTime = lastItem?.endTime || '';
            const firstStartTime = schedule[0]?.startTime || '';

            const itemsList = schedule.map((item, itemIdx) => {
                const partInfo = item.part ? ` (×—×œ×§ ${item.part}/${item.totalParts})` : '';
                let weightInfo = '';
                if(item.type === 'D') weightInfo = '<span style="color:#d32f2f;font-size:10px;">(Ã—2)</span>';
                else if(['A', 'A1', 'A2'].includes(item.type)) weightInfo = '<span style="color:#4caf50;font-size:10px;">(Ã—â…“)</span>';

                // ×”×¦×’ ×˜×•×•×— ×–×× ×™×
                let timeDisplay = '';
                if(item.startTime && item.endTime) {
                    timeDisplay = `<span style="color:#1565c0; font-weight:bold;">â°${item.startTime}-${item.endTime}</span>`;
                } else if(item.startTime) {
                    timeDisplay = `<span style="color:#1565c0;">â°${item.startTime}</span>`;
                }

                // ×›×¤×ª×•×¨×™ +/- ×œ×”×¢×‘×¨×ª × ×‘×—×Ÿ ×‘×•×“×“
                return `<li style="display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid #eee;">
                    <span>${timeDisplay} ${item.name}${partInfo}: <strong>${item.count}</strong> ${item.type ? `(${item.type})` : ''} ${weightInfo} <span style="color:#888;font-size:10px;">[${item.duration} ×“×§']</span></span>
                    <div style="display:flex; gap:3px; align-items:center;">
                        <select onchange="movePartial(${testerIdx}, ${itemIdx}, this.value, 1)" style="padding:2px; font-size:11px;">
                            <option value="">+1â†’</option>
                            ${assignments.map((other, otherIdx) =>
                                otherIdx !== testerIdx ? `<option value="${otherIdx}">${other.name}</option>` : ''
                            ).join('')}
                        </select>
                        <select onchange="moveItem(${testerIdx}, ${itemIdx}, this.value)" style="padding:2px; font-size:11px;">
                            <option value="">×”×›×œâ†’</option>
                            ${assignments.map((other, otherIdx) =>
                                otherIdx !== testerIdx ? `<option value="${otherIdx}">${other.name}</option>` : ''
                            ).join('')}
                        </select>
                    </div>
                </li>`;
            }).join('');

            // ×—×©×‘ ×¡×”"×› ×–××Ÿ ×¢×‘×•×“×”
            const totalDuration = schedule.reduce((sum, item) => sum + item.duration, 0);
            const totalHours = Math.floor(totalDuration / 60);
            const totalMins = totalDuration % 60;
            const durationStr = totalHours > 0 ? `${totalHours} ×©×¢×•×ª ×•-${totalMins} ×“×§×•×ª` : `${totalMins} ×“×§×•×ª`;

            // ×”×›×Ÿ ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×¢× ×œ×•×— ×–×× ×™×
            let whatsappMsg = `*×—×œ×•×§×ª ×¢×‘×•×“×” - ${date} - ${area}*\n\n`;
            whatsappMsg += `ğŸ‘¤ *${a.name}${a.isLead ? ' (××—×¨××™)' : ''}*\n`;
            whatsappMsg += `×¡×”"×›: ${a.total} × ×‘×—× ×™× (~${durationStr})\n`;
            if(firstStartTime && totalEndTime) {
                whatsappMsg += `ğŸ• ${firstStartTime} - ${totalEndTime}\n`;
            }
            whatsappMsg += `\n×‘×ª×™ ×¡×¤×¨:\n`;
            schedule.forEach(item => {
                const partInfo = item.part ? ` (×—×œ×§ ${item.part}/${item.totalParts})` : '';
                const timeRange = item.startTime && item.endTime ? `${item.startTime}-${item.endTime}` : (item.startTime || '');
                whatsappMsg += `â€¢ ${timeRange ? `â°${timeRange} ` : ''}${item.name}${partInfo}: ${item.count} ${item.type ? `(${item.type})` : ''}\n`;
            });

            html += `
                <div class="tester-assignment" style="${isOverLimit ? 'border: 2px solid #f44336; background: #ffebee;' : ''}">
                    <h4>
                        ${a.name} ${a.isLead ? 'ğŸ‘‘' : ''}
                        <span class="total" style="${isOverLimit ? 'background:#f44336;' : ''}">${a.total} × ×‘×—× ×™× (××©×•×§×œ×œ: ${weightedTotal}) ${isOverLimit ? 'âš ï¸' : ''}</span>
                    </h4>
                    <div style="background:#e3f2fd; padding:5px 10px; border-radius:3px; margin-bottom:8px; font-size:12px;">
                        ğŸ• ×¡×”"×› ×–××Ÿ ×¢×‘×•×“×”: <strong>${durationStr}</strong>
                        ${firstStartTime && totalEndTime ? ` | ${firstStartTime} ×¢×“ ${totalEndTime}` : ''}
                    </div>
                    <ul style="list-style:none; padding:0; margin:0;">${itemsList}</ul>
                    <button class="btn-send-assignment" onclick="sendAssignment('${encodeURIComponent(whatsappMsg)}')" ${isOverLimit ? 'disabled style="opacity:0.5;"' : ''}>
                        ğŸ“± ×©×œ×— ×‘×•×•××˜×¡××¤
                    </button>
                </div>
            `;
        });

        // ×”×•×¡×£ ×¡×™×›×•×
        const totals = assignments.map(a => a.total);
        const weightedTotals = assignments.map(a => a.weightedTotal || a.total);
        const min = Math.min(...totals);
        const max = Math.max(...totals);
        const diff = max - min;
        const weightedMin = Math.min(...weightedTotals);
        const weightedMax = Math.max(...weightedTotals);
        const weightedDiff = (weightedMax - weightedMin).toFixed(1);

        let statusMsg, statusColor;
        if(hasOverflow) {
            statusMsg = 'âŒ ×™×© ×‘×•×—× ×™× ×¢× ×™×•×ª×¨ ×-10 - ×™×© ×œ×ª×§×Ÿ!';
            statusColor = '#ffebee';
        } else if(parseFloat(weightedDiff) <= 1) {
            statusMsg = 'âœ… ×—×œ×•×§×” ×©×•×•×” (×œ×¤×™ ××©×§×œ)!';
            statusColor = '#e8f5e9';
        } else if(parseFloat(weightedDiff) <= 2) {
            statusMsg = 'ğŸ‘ ×—×œ×•×§×” ×¡×‘×™×¨×”';
            statusColor = '#fff3e0';
        } else {
            statusMsg = 'âš ï¸ ×™×© ×”×¤×¨×© - ×©×§×•×œ ×”×ª×××” ×™×“× ×™×ª';
            statusColor = '#fff3e0';
        }

        html += `
            <div style="margin-top:15px; padding:10px; background:${statusColor}; border-radius:5px;">
                <strong>ğŸ“Š ×¡×™×›×•×:</strong><br>
                ×”×¤×¨×© ××§×¡×™××œ×™: ${diff} × ×‘×—× ×™× (××©×•×§×œ×œ: ${weightedDiff})<br>
                <small style="color:#666;">D=Ã—2, A/A1/A2=Ã—â…“</small><br>
                ${statusMsg}
            </div>
        `;

        output.innerHTML = html;
        document.getElementById('distributeResult').style.display = 'block';
    }

    function sendAssignment(encodedMsg) {
        const msg = decodeURIComponent(encodedMsg);
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // ×”×¢×‘×¨×ª ×¤×¨×™×˜ ×©×œ× ××‘×•×—×Ÿ ×œ×‘×•×—×Ÿ ××—×¨
    function moveItem(fromTesterIdx, itemIdx, toTesterIdx) {
        if(toTesterIdx === '' || toTesterIdx === null) return;

        toTesterIdx = parseInt(toTesterIdx);
        const item = currentAssignments[fromTesterIdx].items[itemIdx];
        const count = item.count;

        // ×”×¡×¨ ××”××§×•×¨
        currentAssignments[fromTesterIdx].items.splice(itemIdx, 1);
        currentAssignments[fromTesterIdx].total -= count;

        // ×‘×“×•×§ ×× ×›×‘×¨ ×™×© ×¤×¨×™×˜ ×“×•××” ××¦×œ ×”×™×¢×“
        const existingItem = currentAssignments[toTesterIdx].items.find(i =>
            i.name === item.name && i.type === item.type
        );

        if(existingItem) {
            existingItem.count += count;
        } else {
            currentAssignments[toTesterIdx].items.push(item);
        }
        currentAssignments[toTesterIdx].total += count;

        // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
        displayDistribution(currentAssignments);
    }

    // ×”×¢×‘×¨×ª ×›××•×ª ×—×œ×§×™×ª ××¤×¨×™×˜
    function movePartial(fromTesterIdx, itemIdx, toTesterIdx, amount) {
        if(toTesterIdx === '' || toTesterIdx === null) return;

        toTesterIdx = parseInt(toTesterIdx);
        amount = parseInt(amount);
        const item = currentAssignments[fromTesterIdx].items[itemIdx];

        if(amount >= item.count) {
            // ×× ××¢×‘×™×¨×™× ××ª ×”×›×œ, ×¤×©×•×˜ ×”×©×ª××© ×‘-moveItem
            moveItem(fromTesterIdx, itemIdx, toTesterIdx);
            return;
        }

        // ×”×¤×—×ª ××”××§×•×¨
        item.count -= amount;
        currentAssignments[fromTesterIdx].total -= amount;

        // ×”×•×¡×£ ×œ×™×¢×“ - ×‘×“×•×§ ×× ×›×‘×¨ ×™×© ×¤×¨×™×˜ ×“×•××”
        const existingItem = currentAssignments[toTesterIdx].items.find(i =>
            i.name === item.name && i.type === item.type
        );

        if(existingItem) {
            existingItem.count += amount;
        } else {
            currentAssignments[toTesterIdx].items.push({
                name: item.name,
                count: amount,
                type: item.type,
                original: item.original || item.name
            });
        }
        currentAssignments[toTesterIdx].total += amount;

        // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
        displayDistribution(currentAssignments);
    }

    // ×¡×’×•×¨ modal ×‘×œ×—×™×¦×” ××—×•×¥
    document.getElementById('distributeModal')?.addEventListener('click', function(e) {
        if(e.target === this) closeDistributeModal();
    });
    document.getElementById('shareModal')?.addEventListener('click', function(e) {
        if(e.target === this) closeShareModal();
    });

    // ============ ×©×™×ª×•×£ ×•×™×™×‘×•× × ×ª×•× ×™× ============
    let importedTesters = [];

    function openShareModal() {
        // ×¢×“×›×Ÿ ×§×•×“ ××–×•×¨
        document.getElementById('shareAreaCode').value = document.getElementById('areaCode').value || '';

        // ×¢×“×›×Ÿ ×¨×©×™××ª ×‘×•×—× ×™× ×œ×™×™×¦×•×
        const testersInput = document.getElementById('testersInput').value;
        const exportSelect = document.getElementById('exportTesterName');
        exportSelect.innerHTML = '<option value="">×‘×—×¨ ×‘×•×—×Ÿ...</option>';
        if(testersInput) {
            testersInput.split(',').forEach(t => {
                const name = t.trim();
                if(name) exportSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }

        // ×”×¦×’ ×‘×•×—× ×™× ××™×•×‘××™×
        renderImportedTesters();

        document.getElementById('shareModal').classList.add('active');
    }

    function closeShareModal() {
        document.getElementById('shareModal').classList.remove('active');
    }

    // ×™×¦×™×¨×ª ×§×•×“ ××–×•×¨ ××•×˜×•××˜×™
    function generateAreaCode() {
        const date = document.getElementById('dateInput').value;
        const areaSelect = document.getElementById('areaSelect');
        const area = areaSelect.options[areaSelect.selectedIndex]?.text || '';

        if(date && area && area !== '×‘×—×¨ ××–×•×¨...' && area !== '') {
            const parts = date.split('/');
            if(parts.length >= 2) {
                const dd = parts[0].padStart(2, '0');
                const mm = parts[1].padStart(2, '0');
                const yy = parts.length > 2 ? parts[2].slice(-2) : '';
                const areaCode = area.slice(0, 2);
                const newCode = `${dd}${mm}${yy}-${areaCode}`;
                document.getElementById('areaCode').value = newCode;
                localStorage.setItem('header_area_code', newCode);
            }
        }
    }

    function copyAreaCode() {
        const code = document.getElementById('shareAreaCode').value;
        if(!code) {
            alert('××™×Ÿ ×§×•×“ ××–×•×¨');
            return;
        }
        navigator.clipboard.writeText(code).then(() => {
            alert('×”×§×•×“ ×”×•×¢×ª×§!');
        });
    }

    // ×™×™×¦×•× × ×ª×•× ×™× - ×œ×©×œ×™×—×” ×œ×‘×•×—×Ÿ ××—×¨××™
    function exportMyData() {
        const areaCode = document.getElementById('areaCode').value.trim();
        const testerName = document.getElementById('exportTesterName').value;

        if (!areaCode) {
            alert('×™×© ×œ×”×–×™×Ÿ ×§×•×“ ××–×•×¨ ××©×•×ª×£');
            return;
        }
        if (!testerName) {
            alert('×™×© ×œ×‘×—×•×¨ ×‘×•×—×Ÿ');
            return;
        }

        // ××¡×•×£ × ×ª×•× ×™× ××˜×‘×œ×ª ×”×¤×™×¨×•×˜ - ×¨×§ ×©×•×¨×•×ª ×¢× ×ª×•×¦××”
        const examData = [];
        document.querySelectorAll('#examTableBody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            const resultSelect = row.querySelector('.result-select');
            const result = resultSelect?.value;

            if(result && (result === '×¢×‘×¨' || result === '× ×›×©×œ')) {
                // ×§×‘×œ ×©× ×‘×™×ª ×¡×¤×¨
                const schoolSelect = row.querySelector('.school-select');
                const schoolOther = row.querySelector('.school-other');
                let schoolName = schoolSelect?.value || '';
                if(schoolName === 'other' && schoolOther) schoolName = schoolOther.value;

                // ×§×‘×œ ×‘×•×—×Ÿ
                const testerSelect = row.querySelector('.exam-tester-select');
                const rowTester = testerSelect?.value || '';

                // ×™×™×¦× ×¨×§ ××ª ×”× ×ª×•× ×™× ×©×œ ×”×‘×•×—×Ÿ ×”× ×‘×—×¨
                if(rowTester === testerName) {
                    const inputs = row.querySelectorAll('input.exam-input');
                    const selects = row.querySelectorAll('select.exam-input');

                    examData.push({
                        school: schoolName,
                        vehicleNum: row.querySelector('.vehicle-num-select')?.value || '',
                        id: inputs[0]?.value || '', // ×ª.×–
                        name: inputs[1]?.value || '', // ×©×
                        grade: row.querySelector('.grade-select')?.value || '',
                        population: selects[1]?.value || '', // ××•×›×œ×•×¡×™×”
                        testNum: selects[2]?.value || '', // ××¡×¤×¨ ××‘×—×Ÿ
                        result: result === '×¢×‘×¨' ? 'pass' : 'fail'
                    });
                }
            }
        });

        if (examData.length === 0) {
            alert('××™×Ÿ × ×‘×—× ×™× ×¢× ×ª×•×¦××•×ª ×œ×™×™×¦×•× ×¢×‘×•×¨ ×”×‘×•×—×Ÿ ×©× ×‘×—×¨');
            return;
        }

        const exportObj = {
            v: 1,
            code: areaCode,
            tester: testerName,
            examinees: examData
        };

        // ×§×™×“×•×“ ×œ-Base64
        const jsonStr = JSON.stringify(exportObj);
        const encoded = btoa(unescape(encodeURIComponent(jsonStr)));

        // ×”×¢×ª×§ ×œ×œ×•×—
        navigator.clipboard.writeText(encoded).then(() => {
            const status = document.getElementById('exportStatus');
            status.innerHTML = `<div style="background: #4CAF50; color: white; padding: 10px; border-radius: 5px;">
                âœ… ×”×•×¢×ª×§! ×©×œ×— ×‘×•×•××˜×¡××¤ ×œ×‘×•×—×Ÿ ×”××—×¨××™<br>
                <small>(${examData.length} × ×‘×—× ×™×)</small>
            </div>`;
        }).catch(() => {
            prompt('×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×”×–×” ×•×©×œ×— ×œ×‘×•×—×Ÿ ×”××—×¨××™:', encoded);
        });
    }

    // ×™×™×‘×•× × ×ª×•× ×™× - ×œ×‘×•×—×Ÿ ××—×¨××™
    function importTesterData() {
        const text = document.getElementById('importDataText').value.trim();
        const myAreaCode = document.getElementById('areaCode').value.trim();
        const status = document.getElementById('importStatus');

        if (!text) {
            status.innerHTML = '<span style="color: red;">×™×© ×œ×”×“×‘×™×§ × ×ª×•× ×™×</span>';
            return;
        }

        try {
            // ×¤×¢× ×•×— Base64
            const jsonStr = decodeURIComponent(escape(atob(text)));
            const data = JSON.parse(jsonStr);

            // ×‘×“×™×§×ª ×§×•×“ ××–×•×¨
            if (myAreaCode && data.code !== myAreaCode) {
                if (!confirm(`×§×•×“ ×”××–×•×¨ ×œ× ×ª×•××!\n×©×œ×š: ${myAreaCode}\n×”×ª×§×‘×œ: ${data.code}\n\n×œ×™×™×‘× ×‘×›×œ ×–××ª?`)) {
                    return;
                }
            }

            // ×‘×“×•×§ ×× ×”×‘×•×—×Ÿ ×›×‘×¨ ×™×•×‘×
            const existingIdx = importedTesters.findIndex(t => t.tester === data.tester);
            if (existingIdx >= 0) {
                if (!confirm(`× ×ª×•× ×™× ×"${data.tester}" ×›×‘×¨ ×§×™×™××™×. ×œ×”×—×œ×™×£?`)) {
                    return;
                }
                importedTesters.splice(existingIdx, 1);
            }

            // ×”×•×¡×£ ×œ×¨×©×™××ª ×”×‘×•×—× ×™× ×”××™×•×‘××™×
            importedTesters.push({
                tester: data.tester,
                examinees: data.examinees
            });

            // × ×§×” ×©×“×” ×”×§×œ×˜
            document.getElementById('importDataText').value = '';

            // ×¢×“×›×Ÿ ×ª×¦×•×’×”
            renderImportedTesters();
            saveImportedTesters();

            status.innerHTML = `<span style="color: green;">âœ… ×™×•×‘××• ${data.examinees.length} × ×‘×—× ×™× ×"${data.tester}"</span>`;

        } catch (e) {
            status.innerHTML = '<span style="color: red;">âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”× ×ª×•× ×™× - ×•×“× ×©×”×¢×ª×§×ª × ×›×•×Ÿ</span>';
            console.error(e);
        }
    }

    // ×”×¦×’×ª ×¨×©×™××ª ×‘×•×—× ×™× ×©×™×•×‘××•
    function renderImportedTesters() {
        const container = document.getElementById('importedTestersList');
        if (!container) return;

        if (importedTesters.length === 0) {
            container.innerHTML = '';
            return;
        }

        let html = '<h4 style="margin: 10px 0 5px 0; color: #2e7d32;">×‘×•×—× ×™× ×©×™×•×‘××•:</h4>';
        importedTesters.forEach((t, idx) => {
            const passCount = t.examinees.filter(e => e.result === 'pass').length;
            const failCount = t.examinees.filter(e => e.result === 'fail').length;
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 5px; margin-bottom: 5px;">
                    <div>
                        <strong>${t.tester}</strong>
                        <span style="color: #666; font-size: 12px;">(${t.examinees.length} × ×‘×—× ×™×: ${passCount} âœ“ / ${failCount} âœ—)</span>
                    </div>
                    <div>
                        <button onclick="addImportedToTable(${idx})" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">×”×•×¡×£ ×œ×˜×‘×œ×”</button>
                        <button onclick="removeImportedTester(${idx})" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">×”×¡×¨</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // ×”×¡×¨×ª ×‘×•×—×Ÿ ××™×•×‘×
    function removeImportedTester(idx) {
        importedTesters.splice(idx, 1);
        renderImportedTesters();
        saveImportedTesters();
    }

    // ×”×•×¡×¤×ª × ×ª×•× ×™× ××™×•×‘××™× ×œ×˜×‘×œ×ª ×”×¤×™×¨×•×˜
    function addImportedToTable(idx) {
        const imported = importedTesters[idx];
        if(!imported) return;

        // ××¦× ×©×•×¨×•×ª ×¨×™×§×•×ª ×‘×˜×‘×œ×”
        const rows = document.querySelectorAll('#examTableBody tr');
        let addedCount = 0;

        imported.examinees.forEach(ex => {
            // ×—×¤×© ×©×•×¨×” ×¨×™×§×”
            let targetRow = null;
            for(const row of rows) {
                const resultSelect = row.querySelector('.result-select');
                const nameInput = row.querySelectorAll('input.exam-input')[1];
                if(!resultSelect?.value && !nameInput?.value) {
                    targetRow = row;
                    break;
                }
            }

            if(targetRow) {
                // ××œ× ××ª ×”×©×•×¨×”
                const schoolSelect = targetRow.querySelector('.school-select');
                if(schoolSelect) {
                    // × ×¡×” ×œ××¦×•× ××ª ×‘×™×ª ×”×¡×¤×¨ ×‘×¨×©×™××”
                    const option = Array.from(schoolSelect.options).find(o => o.value === ex.school);
                    if(option) {
                        schoolSelect.value = ex.school;
                    } else if(ex.school) {
                        schoolSelect.value = 'other';
                        toggleOtherInput(schoolSelect);
                        const otherInput = targetRow.querySelector('.school-other');
                        if(otherInput) otherInput.value = ex.school;
                    }
                    onExamSchoolChange(schoolSelect);
                }

                const vehicleSelect = targetRow.querySelector('.vehicle-num-select');
                if(vehicleSelect && ex.vehicleNum) {
                    // ×”×•×¡×£ ××•×¤×¦×™×” ×× ×œ× ×§×™×™××ª
                    if(!vehicleSelect.querySelector(`option[value="${ex.vehicleNum}"]`)) {
                        vehicleSelect.innerHTML += `<option value="${ex.vehicleNum}">${ex.vehicleNum}</option>`;
                    }
                    vehicleSelect.value = ex.vehicleNum;
                }

                const inputs = targetRow.querySelectorAll('input.exam-input');
                if(inputs[0]) inputs[0].value = ex.id || ''; // ×ª.×–
                if(inputs[1]) inputs[1].value = ex.name || ''; // ×©×

                const gradeSelect = targetRow.querySelector('.grade-select');
                if(gradeSelect && ex.grade) gradeSelect.value = ex.grade;

                const selects = targetRow.querySelectorAll('select.exam-input');
                if(selects[1] && ex.population) selects[1].value = ex.population; // ××•×›×œ×•×¡×™×”

                const testerSelect = targetRow.querySelector('.exam-tester-select');
                if(testerSelect) testerSelect.value = imported.tester;

                if(selects[2] && ex.testNum) selects[2].value = ex.testNum; // ××¡×¤×¨ ××‘×—×Ÿ

                const resultSelect = targetRow.querySelector('.result-select');
                if(resultSelect) {
                    resultSelect.value = ex.result === 'pass' ? '×¢×‘×¨' : '× ×›×©×œ';
                    checkFail(resultSelect);
                }

                addedCount++;
            }
        });

        saveExamData();
        updateTesterCounts();

        alert(`× ×•×¡×¤×• ${addedCount} × ×‘×—× ×™× ×œ×˜×‘×œ×”`);

        // ×”×¡×¨ ××ª ×”×‘×•×—×Ÿ ×”××™×•×‘× ××”×¨×©×™××”
        if(addedCount === imported.examinees.length) {
            removeImportedTester(idx);
        }
    }

    // ×©××™×¨×ª ×‘×•×—× ×™× ××™×•×‘××™×
    function saveImportedTesters() {
        localStorage.setItem('imported_testers', JSON.stringify(importedTesters));
    }

    // ×˜×¢×™× ×ª ×‘×•×—× ×™× ××™×•×‘××™×
    function loadImportedTesters() {
        const saved = localStorage.getItem('imported_testers');
        if(saved) {
            importedTesters = JSON.parse(saved);
        }
    }

</script>
</body>
</html>