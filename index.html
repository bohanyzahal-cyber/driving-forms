<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™×“×•×¨ ×¢×‘×•×“×” ×•×“×•×— ×‘×•×—×Ÿ</title>
    <style>
        body { background-color: #525659; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .a4-page { 
            background-color: white; 
            width: 210mm; 
            min-height: 297mm; 
            padding: 15mm; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); 
            box-sizing: border-box; 
            position: relative; 
        }

        /* ×”×’×“×¨×•×ª */
        .settings-panel { background: #e3f2fd; border: 1px solid #90caf9; padding: 10px; margin-bottom: 20px; border-radius: 5px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; direction: rtl; }
        .settings-panel input, .settings-panel select { width: 100%; padding: 4px; font-size: 13px; font-weight: bold; }
        .settings-title { grid-column: span 4; font-weight: bold; text-align: center; color: #0d47a1; margin-bottom: 5px; }

        /* ×›×•×ª×¨×•×ª */
        .header-section { text-align: center; margin-bottom: 10px; }
        .main-title { font-size: 20px; margin: 0; font-weight: normal; }
        .sub-title { font-size: 16px; font-weight: bold; margin-top: 3px; }

        /* ×˜×‘×œ××•×ª */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; direction: rtl; table-layout: fixed; }
        th, td { border: 1px solid #000; padding: 1px; text-align: center; font-size: 11px; vertical-align: middle; height: 26px; overflow: hidden; }
        thead th { background-color: #e7e6e6; font-weight: bold; height: auto; padding: 3px; }
        
        /* ×©×•×¨×ª ×¡×™×›×•× */
        tfoot tr { background-color: #d1e7dd; font-weight: bold; border-top: 2px solid #000; }
        tfoot input { font-weight: bold; color: #000; }
        .grand-total { font-size: 13px; color: #000; background: #badbcc !important; border: 2px solid #0f5132 !important; }

        /* ×§×œ×˜×™× */
        input.tbl-input, select.tbl-input { width: 100%; border: none; background: transparent; text-align: center; font-size: 12px; outline: none; font-family: inherit; padding: 0; margin: 0; }
        select.tbl-input { -webkit-appearance: none; appearance: none; cursor: pointer; padding-right: 2px;}

        /* ×ª×™×§×•×Ÿ ×œ×©×“×” ×©×¢×” */
        input[type="time"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; background: transparent; }
        input[type="time"]::-webkit-calendar-picker-indicator { display: none !important; background: none !important; width: 0; height: 0; }
        input[type="time"]::-webkit-date-and-time-value { text-align: center; }
        input[type="time"].tbl-input { font-size: 11px; padding: 0; width: 100%; display: block; }

        /* ×©×“×” ×§×œ×˜ "××—×¨" ××™×•×—×“ */
        input.other-input { 
            display: none; 
            border-bottom: 1px dashed #000; 
            background: #fff; 
            width: 90%; 
            margin: 0 auto;
            font-size: 11px;
            height: 20px;
        }

        /* ×›×¤×ª×•×¨×™× */
        .floating-controls { position: fixed; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .table-actions { display: flex; gap: 10px; margin-bottom: 5px; direction: rtl; }
        button { border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; }
        .btn-print { background-color: #007bff; }
        .btn-reset { background-color: #dc3545; }
        .btn-add { background-color: #28a745; }
        .btn-remove { background-color: #6c757d; }
        .clear-sig-btn { background-color: #6c757d; margin-top: 5px; font-size: 10px; padding: 2px 6px; width: auto; display: inline-block; }

        /* ×—×ª×™××•×ª */
        .signature-section { display: flex; justify-content: space-between; margin-top: 20px; align-items: flex-end; }
        .sig-box { width: 45%; text-align: center; }
        .tester-details { font-weight: bold; font-size: 12px; line-height: 1.3; white-space: pre-line; min-height: 40px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center;}
        
        canvas { border: 1px dashed #999; cursor: crosshair; background: #fff; display: block; margin: 0 auto; }

        @media print { 
            body { background: white; padding: 0; margin: 0; }
            .floating-controls, .settings-panel, .table-actions, .clear-sig-btn { display: none !important; }
            .a4-page { box-shadow: none; margin: 0; width: 100%; height: 100%; padding: 10mm 10mm 5mm 10mm; overflow: hidden; }
            td, th { height: 24px; padding: 0; } 
            .header-section { margin-bottom: 5px; }
            table { margin-bottom: 8px; }
            .signature-section { margin-top: 10px; }
            .school-select.hidden-print { display: none; }
            input.other-input.visible-print { display: block; border: none; font-weight: bold; text-align: center;}
        }
    </style>
</head>
<body>

<div class="floating-controls">
    <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ×”×“×¤×¡ / ×©××•×¨ ×›-PDF</button>
    <button class="btn-reset" onclick="resetForm()">ğŸ”„ × ×§×” ×”×›×œ</button>
</div>

<div class="a4-page">
    
    <div class="settings-panel">
        <div class="settings-title">×”×’×“×¨×•×ª ×¤×§×•×“×ª ×¢×‘×•×“×”</div>
        <div><label>×™×•×:</label><select id="daySelect" onchange="updateHeader()"><option>×</option><option>×‘</option><option>×’</option><option>×“</option><option>×”</option></select></div>
        <div><label>×ª××¨×™×š:</label><input type="text" id="dateInput" placeholder="dd/mm/yy" oninput="updateHeader()"></div>
        <div><label>××–×•×¨:</label><select id="areaSelect" onchange="handleAreaChange()"><option value="">×‘×—×¨ ××–×•×¨...</option></select></div>
        <div><label>×‘×•×—× ×™×:</label><input type="text" id="testersInput" placeholder="×”×§×œ×“ ×©××•×ª..." oninput="updateHeader()"></div>
    </div>

    <div class="header-section">
        <h1 class="main-title" id="dynamicTitle">×¡×™×“×•×¨ ×¢×‘×•×“×” ×œ×™×•× ...</h1>
        <div class="sub-title" id="dynamicTesters">×”×‘×•×—× ×™×: ...</div>
    </div>

    <div class="table-actions">
        <button class="btn-add" onclick="addPlanRow()">+ ×”×•×¡×£ ×©×•×¨×”</button>
        <button class="btn-remove" onclick="removePlanRow()">- ××—×§ ×©×•×¨×”</button>
    </div>

    <table id="planTable">
        <colgroup>
            <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
            <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
            <col style="width: 9%;"> <col style="width: 16%;">
            <col style="width: 7%;"> <col style="width: 7%;"> <col style="width: 7%;"> <col style="width: 19%;">
        </colgroup>
        <thead>
            <tr>
                <th colspan="8">×‘×™×¦×•×¢</th>
                <th rowspan="2">×©×¢×”</th>
                <th rowspan="2">×”×¢×¨×•×ª</th>
                <th colspan="4">×ª×›× ×•×Ÿ</th>
            </tr>
            <tr>
                <th colspan="4">× ×›×©×œ</th>
                <th colspan="4">×¢×‘×¨</th>
                <th>×›××•×ª<br>×××•×©×¨×ª</th>
                <th>×›××•×ª<br>××‘×•×§×©×ª</th>
                <th>×¡×•×’<br>×¨×›×‘</th>
                <th>×‘×™×”"×¡</th>
            </tr>
            <tr style="font-size: 10px;">
                <th>×©×•× ×•×ª</th><th>×¦×‘×</th><th>×•××•×¦'×¨</th><th>×§×“"×¦</th>
                <th>×©×•× ×•×ª</th><th>×¦×‘×</th><th>×•××•×¦'×¨</th><th>×§×“"×¦</th>
                <th></th><th></th><th></th><th></th><th></th><th></th>
            </tr>
        </thead>
        <tbody id="planningTableBody"></tbody>
        <tfoot>
            <tr>
                <td><input class="tbl-input sum-fail" readonly></td>
                <td><input class="tbl-input sum-fail" readonly></td>
                <td><input class="tbl-input sum-fail" readonly></td>
                <td><input class="tbl-input sum-fail" readonly></td>
                <td><input class="tbl-input sum-pass" readonly></td>
                <td><input class="tbl-input sum-pass" readonly></td>
                <td><input class="tbl-input sum-pass" readonly></td>
                <td><input class="tbl-input sum-pass" readonly></td>
                <td colspan="2" style="text-align: left; padding-left: 5px;">×¡×”"×› ×‘×™×¦×•×¢:</td>
                <td colspan="4"><input id="grandTotalDisplay" class="tbl-input grand-total" readonly></td>
            </tr>
        </tfoot>
    </table>

    <div style="text-align: right; font-weight: bold; margin: 10px 0 3px 0; border-bottom: 1px solid #000; font-size: 13px;">
        ×¤×™×¨×•×˜ × ×‘×—× ×™×:
    </div>

    <table>
        <colgroup>
            <col style="width: 4%;">  <col style="width: 18%;"> <col style="width: 10%;"> <col style="width: 13%;"> <col style="width: 20%;"> <col style="width: 8%;">  <col style="width: 10%;"> <col style="width: 7%;">  <col style="width: 10%;"> </colgroup>
        <thead>
            <tr>
                <th>××¡'</th>
                <th>×©× ×‘×™×”"×¡</th>
                <th>××¡' ×¨×›×‘</th> 
                <th>×ª.×–</th>
                <th>×©× ×”× ×‘×—×Ÿ</th>
                <th>×“×¨×’×”</th>
                <th>××•×›×œ×•×¡×™×”</th>
                <th>××‘×—×Ÿ</th>
                <th>×ª×•×¦××”</th>
            </tr>
        </thead>
        <tbody id="examTableBody"></tbody>
    </table>

    <div style="border: 1px solid #000; padding: 5px; height: 45px; margin-top: 5px;">
        <strong style="font-size: 12px;">×”×¢×¨×•×ª ×›×œ×œ×™×•×ª:</strong>
        <textarea id="generalNotes" style="width: 100%; border: none; resize: none; font-family: inherit; height: 25px;" rows="1" oninput="saveAllInputs()"></textarea>
    </div>

    <div class="signature-section">
        <div class="sig-box">
            <div id="testerDetailsDisplay" class="tester-details"></div>
            <div style="border-top: 1px solid #000; width: 80%; margin: 2px auto;"></div>
            <strong>×¤×¨×˜×™ ×‘×•×—×Ÿ ××—×¨××™</strong>
        </div>

        <div class="sig-box">
            <canvas id="sig-canvas" width="180" height="60"></canvas>
            <button class="clear-sig-btn" onclick="clearSig()">× ×§×” ×—×ª×™××”</button>
            <div style="border-top: 1px solid #000; width: 80%; margin: 2px auto;"></div>
            <strong>×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</strong>
        </div>
    </div>
</div>

<script>
    // --- × ×ª×•× ×™× ---
    const testersDB = {
        "×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ": "×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' 3604",
        "××œ×œ×•×£ ×™×¦×—×§": "××œ×œ×•×£ ×™×¦×—×§\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×“×¨×•×¨ ××œ×œ": "×“×¨×•×¨ ××œ×œ\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "××œ×‘×œ×” ××‘×¨×”×": "××œ×‘×œ×” ××‘×¨×”×\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×‘× ×™ ×œ×•×™": "×‘× ×™ ×œ×•×™\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×©××©×•×Ÿ × ×’××•×§×¨": "×©××©×•×Ÿ × ×’××•×§×¨\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "××œ×§×¡ ×§×•×¨× ×‘×œ×™×˜": "××œ×§×¡ ×§×•×¨× ×‘×œ×™×˜\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×¦×¨×™××™ ×©×¨×•×Ÿ": "×¦×¨×™××™ ×©×¨×•×Ÿ\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×™× ×™×¨ × ××•×’××•×§×¨": "×™× ×™×¨ × ××•×’××•×§×¨\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×“×•×“×• ×¤×œ×¡": "×“×•×“×• ×¤×œ×¡\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×¨×•×Ÿ ×™×”×•×“": "×¨×•×Ÿ ×™×”×•×“\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____",
        "×œ×•×™ ×‘× ×™××™×Ÿ": "×œ×•×™ ×‘× ×™××™×Ÿ\n×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ\n××¡' ____"
    };

    const schoolMap = {
        "×‘××¨ ×©×‘×¢": ["×©×¨×™×™×‘×¨", "×™×•×‘×œ×™", "×¢×œ ×’×œ×’×œ×™×", "×™×—×“", "××™×¦×™×§", "×‘.×” 6930"],
        "××•×¤×§×™×/× ×ª×™×‘×•×ª": ["×©×™ ××•×¤×§×™×", "×‘.×” 6930", "××•×¤×§×™×"],
        "×“×™××•× ×”": ["×¢×œ ×’×œ×’×œ×™×", "×“×™××•× ×”", "×¢×™×•×Ÿ"],
        "××©×§×œ×•×Ÿ": ["××™×—×•×“", "××©×§×œ×•×Ÿ", "×‘.×” 6930"],
        "×§×¨×™×ª ×’×ª": ["×“× ×™", "×§×¨×™×ª ×’×ª"],
        "××©×“×•×“": ["×–×”×‘", "××©×“×•×“"],
        "×œ×•×“": ["×‘.×” 6920", "××™×™×œ×•×Ÿ", "×™×•×‘×œ×™", "×¢×œ ×’×œ×’×œ×™×"],
        "×‘×™×ª × ×‘××œ×œ×”/×©×•×”×": ["×‘.×” 6920", "×¢×™×•×Ÿ", "×‘×™×ª × ×‘××œ×œ×”"],
        "×¦×¨×™×¤×™×Ÿ": ["×‘×”×“ 6", "×¨×™×©×•×™"],
        "×¨×—×•×‘×•×ª": ["×™×•×‘×œ×™", "×¨×—×•×‘×•×ª"],
        "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ": ["×©×¢×¨ ×¨××©×•×Ÿ", "×©×¨×™×™×‘×¨", "×©×¨×™×™×‘×¨ ××•×¤× ×•×¢×™×"],
        "×™×¤×•/×ª×œ ××‘×™×‘": ["×.×¡×œ×¢", "×™×—×“×™×•", "×¨×™×©×•×™", "×©×¨×™×™×‘×¨", "××™×—×•×“"],
        "×¤×ª×— ×ª×§×•×•×”": ["×§×¨×Ÿ", "××“×™", "×©×¨×™×™×‘×¨", "×˜×œ", "××“×¨"],
        "×”×“×¨ ×™×•×¡×£": ["×’×•×œ×Ÿ", "×’×•×¨ ××¨×™×”", "×©×¨×™×™×‘×¨"],
        "× ×ª× ×™×”": ["××•×¨×Ÿ ×ª××™×¨", "×©×’×™×", "×©×¨×™×™×‘×¨"],
        "×—×“×¨×”": ["××•×˜×•", "× ×ª×™×‘", "×©×¨×™×™×‘×¨"],
        "×›×¤×¨ ×¡×‘×": ["×©×¨×™×™×‘×¨", "×˜×•×‘", "×”×“×¨×›×™×"],
        "×—×™×¤×”": ["× ×ª×™×‘", "××•××Ÿ", "×—×™×¤×”", "×‘.×” 6910"],
        "×¢×›×•": ["××¨×’××Ÿ", "×¡××™×¨", "× ×ª×™×‘×™ ×”×’×œ×™×œ"],
        "×¢×¤×•×œ×”": ["×”×—××™×©×”", "×œ×™×Ÿ", "×‘.×” 6910", "×™×”×‘", "×©×¨×™×™×‘×¨"],
        "×˜×‘×¨×™×”/×§×¨×™×ª ×©××•× ×”": ["×”××•×Ÿ", "×¨×•×××” ×’×œ×™×œ", "× ××¨×•×“ ×¡×¢×¨"],
        "×™×¨×•×©×œ×™×": ["×©×¨×™×™×‘×¨", "×“×¨×›×™×", "×œ×’ ×™×¨×•×©×œ×™×", "×¢×œ ×’×œ×’×œ×™×", "×¢×•×–"],
        "×‘×”×œ×¥": ["×˜×¨×§×˜×•×¨ ×¢×™×•× ×™", "×˜×¨×§×˜×•×¨ ××¢×©×™", "×‘×”×“ 14"]
    };

    const vehicleTypes = ['','1','A1','A','B','C1','C','E','D'];
    const popTypes = ['','×§×“"×¦','×•××•×¦\'×¨','×¦×‘×','×¤×¨×˜×™/××—×¨'];
    
    let planRowCount = 0;

    // --- ××ª×—×•×œ ×—×›× ×‘×¡×“×¨ ×”× ×›×•×Ÿ ---
    window.onload = function() {
        // 1. ×§×•×“× ×˜×•×¢× ×™× ××ª ×”×”×’×“×¨×•×ª ×”×¨××©×™×•×ª (×ª××¨×™×š, ××–×•×¨)
        loadSettings();
        
        // 2. ××—×¨×™ ×©×”××–×•×¨ × ×˜×¢×Ÿ, ××™×™×¦×¨×™× ××ª ×”×˜×‘×œ××•×ª (×›×“×™ ×©×™×”×™×• ×‘×ª×™ ×¡×¤×¨ × ×›×•× ×™×)
        initTables(); 
        
        // 3. ×¨×§ ×‘×¡×•×£ ×©×•×¤×›×™× ××ª ×”××™×“×¢ ×œ×ª×•×š ×”×˜×‘×œ××•×ª
        loadTableData();
        
        initSignature();
    };

    function loadSettings() {
        if(localStorage.getItem('header_day')) document.getElementById('daySelect').value = localStorage.getItem('header_day');
        if(localStorage.getItem('header_date')) document.getElementById('dateInput').value = localStorage.getItem('header_date');
        if(localStorage.getItem('header_testers')) document.getElementById('testersInput').value = localStorage.getItem('header_testers');
        if(localStorage.getItem('general_notes')) document.getElementById('generalNotes').value = localStorage.getItem('general_notes');
        
        const savedAreaIdx = localStorage.getItem('header_area_idx');
        initAreaSelect(); // ×‘× ×™×™×ª ×”×¡×œ×§×˜
        
        if(savedAreaIdx) { 
            document.getElementById('areaSelect').selectedIndex = savedAreaIdx; 
            handleAreaChange(); // ×–×” ×§×¨×™×˜×™! ×–×” ××¢×“×›×Ÿ ××ª ×”××©×ª× ×” ×”×’×œ×•×‘×œ×™ ×©×œ ×‘×ª×™ ×”×¡×¤×¨ ×œ×¤× ×™ ×‘× ×™×™×ª ×”×˜×‘×œ××•×ª
        } else {
            handleAreaChange(); // ×‘×¨×™×¨×ª ××—×“×œ
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×‘× ×™×™×ª ×©×œ×“ ×”×˜×‘×œ×”
    function initTables() {
        // ×˜×‘×œ×” ×¢×œ×™×•× ×” - ××©×—×–×¨ ×›××•×ª ×©×•×¨×•×ª
        const savedCount = parseInt(localStorage.getItem('plan_rows_count')) || 4;
        const planBody = document.getElementById('planningTableBody');
        planBody.innerHTML = ''; // × ×™×§×•×™
        planRowCount = 0;
        for(let i=0; i<savedCount; i++) addPlanRow(); // ×”×•×¡×¤×ª ×©×•×¨×•×ª ×¨×™×§×•×ª

        // ×˜×‘×œ×” ×ª×—×ª×•× ×” - ×ª××™×“ 10 ×©×•×¨×•×ª
        const examBody = document.getElementById('examTableBody');
        examBody.innerHTML = '';
        
        const typeOptions = vehicleTypes.map(v => `<option value="${v}">${v}</option>`).join('');
        const popOptions = popTypes.map(v => `<option value="${v}">${v}</option>`).join('');
        let testNumOptions = '<option></option>';
        for(let j=1; j<=10; j++) testNumOptions += `<option>${j}</option>`;
        
        for(let i=1; i<=10; i++) {
            const rowHtml = `<tr>
                <td>${i}</td>
                <td>${createSchoolCell()}</td>
                <td><input class="tbl-input"></td>
                <td><input class="tbl-input"></td>
                <td><input class="tbl-input" style="text-align:right;"></td>
                <td><select class="tbl-input">${typeOptions}</select></td>
                <td><select class="tbl-input">${popOptions}</select></td>
                <td><select class="tbl-input">${testNumOptions}</select></td>
                <td><select class="tbl-input" onchange="checkFail(this)"><option></option><option>×¢×‘×¨</option><option value="× ×›×©×œ">× ×›×©×œ</option></select></td>
            </tr>`;
            examBody.insertAdjacentHTML('beforeend', rowHtml);
        }
        
        // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×›×œ ×”××™× ×¤×•×˜×™× ×©× ×•×¦×¨×•
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('input', saveAllInputs);
        });
    }

    // ×¤×•× ×§×¦×™×” ×œ××™×œ×•×™ ×”× ×ª×•× ×™× ×‘×˜×‘×œ××•×ª ×”×§×™×™××•×ª
    function loadTableData() {
        const data = JSON.parse(localStorage.getItem('all_data'));
        if(!data) return;

        // ××•×¡×¤×™× ××ª ×›×œ ×”×©×“×•×ª ×©×™×© ×›×¨×’×¢ ×‘×“×£ (××—×¨×™ ×©×‘× ×™× ×• ××•×ª×)
        // ××¡× × ×™× ××ª ×”×”×’×“×¨×•×ª ×œ××¢×œ×” ×›×™ ×›×‘×¨ ×˜×¢× ×• ××•×ª×Ÿ ×‘× ×¤×¨×“
        const inputs = Array.from(document.querySelectorAll('input, select, textarea'))
            .filter(el => !el.closest('.settings-panel') && el.id !== 'generalNotes');

        // ××¦×™×‘×™× ××ª ×”×¢×¨×›×™× ×œ×¤×™ ×”×¡×“×¨
        inputs.forEach((el, index) => {
            if(index < data.length) {
                el.value = data[index];
                
                // ×˜×™×¤×•×œ ××™×•×—×“ ×œ"××—×¨" ×‘×‘×ª×™ ×¡×¤×¨
                if(el.classList.contains('school-select') && el.value === 'other') {
                    toggleOtherInput(el);
                }
            }
        });
        
        calcTotals();
    }

    // --- ×©××™×¨×” ---
    function saveAllInputs() {
        // ×©×•××¨×™× ××ª ×”×”×¢×¨×•×ª ×”×›×œ×œ×™×•×ª ×‘× ×¤×¨×“
        localStorage.setItem('general_notes', document.getElementById('generalNotes').value);

        // ×©×•××¨×™× ××ª ×ª×•×›×Ÿ ×”×˜×‘×œ××•×ª
        const inputs = Array.from(document.querySelectorAll('input, select, textarea'))
            .filter(el => !el.closest('.settings-panel') && el.id !== 'generalNotes');
            
        const vals = inputs.map(el => el.value);
        localStorage.setItem('all_data', JSON.stringify(vals));
    }

    // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (×œ×•×’×™×§×” ×§×•×“××ª) ---

    function initAreaSelect() {
        const sel = document.getElementById('areaSelect');
        sel.innerHTML = '<option value="">×‘×—×¨ ××–×•×¨...</option>'; // ××™×¤×•×¡
        Object.keys(schoolMap).sort().forEach(area => {
            sel.innerHTML += `<option value="${area}">${area}</option>`;
        });
        sel.innerHTML += `<option value="other">××—×¨...</option>`;
    }

    function handleAreaChange() {
        updateHeader();
        const selectedArea = document.getElementById('areaSelect').value;
        const schools = schoolMap[selectedArea] || [];
        let opts = '<option value=""></option>';
        schools.forEach(s => opts += `<option value="${s}">${s}</option>`);
        opts += '<option value="other">××—×¨...</option>';
        
        // ××¢×“×›×Ÿ ××ª ×›×œ ×”×¡×œ×§×˜×™× ×©×œ ×‘×ª×™ ×”×¡×¤×¨ ×‘×“×£
        document.querySelectorAll('.school-select').forEach(selectElem => {
            const currentVal = selectElem.value;
            selectElem.innerHTML = opts;
            // ×× ×¡×™× ×œ×©××•×¨ ×¢×œ ×”×¢×¨×š ×”×§×™×™×
            if (currentVal && (schools.includes(currentVal) || currentVal === 'other')) {
                selectElem.value = currentVal;
            } else {
                selectElem.value = "";
            }
            toggleOtherInput(selectElem);
        });
        // ×œ× ×§×•×¨× ×œ-saveAllInputs ×›××Ÿ ×›×“×™ ×œ× ×œ×“×¨×•×¡ ××™×“×¢ ×‘×˜×¢×™× ×” ×¨××©×•× ×™×ª
    }

    function toggleOtherInput(selectElem) {
        const inputElem = selectElem.nextElementSibling;
        if(selectElem.value === 'other') {
            inputElem.style.display = 'block';
            selectElem.classList.add('hidden-print');
            inputElem.classList.add('visible-print');
        } else {
            inputElem.style.display = 'none';
            if(inputElem.value === '') { // ×¨×§ ×× ×¨×™×§, ×©×œ× ×™××—×§ ××™×“×¢ ×‘×˜×¢×•×ª
                 // inputElem.value = ''; 
            }
            selectElem.classList.remove('hidden-print');
            inputElem.classList.remove('visible-print');
        }
    }

    function createTypeSelect() { return `<select class="tbl-input" style="font-weight:bold;">${vehicleTypes.map(v => `<option value="${v}">${v}</option>`).join('')}</select>`; }
    
    function createSchoolCell() { 
        return `
        <div style="position:relative; width:100%;">
            <select class="tbl-input school-select" style="text-align:right;" onchange="toggleOtherInput(this)">
                <option value=""></option>
            </select>
            <input type="text" class="tbl-input other-input school-other" placeholder="×”×§×œ×“ ×©×..." oninput="saveAllInputs()">
        </div>`; 
    }

    function addPlanRow() {
        const tbody = document.getElementById('planningTableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input class="tbl-input count-fail" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-fail" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-fail" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-fail" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-pass" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-pass" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-pass" type="number" oninput="calcTotals()"></td>
            <td><input class="tbl-input count-pass" type="number" oninput="calcTotals()"></td>
            <td><input type="time" class="tbl-input"></td>
            <td><input class="tbl-input"></td>
            <td><input type="number" class="tbl-input"></td>
            <td><input type="number" class="tbl-input"></td>
            <td>${createTypeSelect()}</td>
            <td>${createSchoolCell()}</td>
        `;
        tbody.appendChild(row);
        
        // ×× ×›×‘×¨ × ×‘×—×¨ ××–×•×¨, × ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ×‘×ª×™ ×”×¡×¤×¨ ×‘×©×•×¨×” ×”×—×“×©×”
        const currentArea = document.getElementById('areaSelect').value;
        if(currentArea) {
             const schools = schoolMap[currentArea] || [];
             let opts = '<option value=""></option>';
             schools.forEach(s => opts += `<option value="${s}">${s}</option>`);
             opts += '<option value="other">××—×¨...</option>';
             row.querySelector('.school-select').innerHTML = opts;
        }

        row.querySelectorAll('input, select').forEach(el => el.addEventListener('input', saveAllInputs));
        
        // ×¢×“×›×•×Ÿ ××•× ×” ×”×©×•×¨×•×ª
        planRowCount = tbody.children.length; 
        saveRowCount();
    }

    function removePlanRow() {
        const tbody = document.getElementById('planningTableBody');
        if (tbody.children.length > 1) { 
            tbody.removeChild(tbody.lastChild); 
            planRowCount = tbody.children.length; 
            saveRowCount(); 
            saveAllInputs(); 
            calcTotals(); 
        }
    }

    function calcTotals() {
        const sums = [0,0,0,0, 0,0,0,0];
        let grandTotal = 0;
        document.querySelectorAll('#planningTableBody tr').forEach(row => {
            row.querySelectorAll('input[type="number"].count-fail, input[type="number"].count-pass').forEach((inp, idx) => {
                const val = parseInt(inp.value) || 0;
                if(idx < 8) { sums[idx] += val; grandTotal += val; }
            });
        });
        document.querySelectorAll('tfoot input.sum-fail, tfoot input.sum-pass').forEach((inp, idx) => { inp.value = sums[idx] > 0 ? sums[idx] : ''; });
        document.getElementById('grandTotalDisplay').value = grandTotal > 0 ? grandTotal : '';
    }

    function checkFail(selectElem) {
        saveAllInputs();
        if (selectElem.value === '× ×›×©×œ') {
            const row = selectElem.closest('tr');
            const inputs = row.querySelectorAll('input:not(.other-input).tbl-input'); 
            const schoolSel = row.querySelector('.school-select');
            const schoolOther = row.querySelector('.school-other');
            const schoolVal = (schoolSel.value === 'other') ? schoolOther.value : schoolSel.value;
            const carVal = inputs[0].value || '';
            const idVal = inputs[1].value || '';
            const nameVal = inputs[2].value || '';
            const dateVal = document.getElementById('dateInput').value || '';
            const testerVal = document.getElementById('testersInput').value.split(',')[0].trim();
            const url = `driving_test.html?name=${encodeURIComponent(nameVal)}&id=${encodeURIComponent(idVal)}&car=${encodeURIComponent(carVal)}&school=${encodeURIComponent(schoolVal)}&date=${encodeURIComponent(dateVal)}&tester=${encodeURIComponent(testerVal)}`;
            window.open(url